{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{% if cheque %}Edit Cheque{% else %}Cheque Form{% endif %}</title>
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet"/>
  <link rel="icon" type="image/x-icon" href="{% static 'sowaf/images/favicon.ico' %}">
  <link rel="stylesheet" href="{% static 'sowaf/styles/style.css' %}" />
  <link rel="stylesheet" href="{% static 'sowaf/styles/bootsrap.min.css' %}" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: "Poppins", sans-serif; font-size: 14px; }
    body { background: #f4f6f8; padding: 30px; }
    .container { background: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); width: 90%; margin: auto; }
    h2.title { text-align: center; color: #39B54B; margin-bottom: 25px; font-size: 28px; font-weight: 700; }
    .section-wrapper { background: #f9f9f9; padding: 20px; border-radius: 10px; margin-bottom: 25px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; }
    .form-group { display: flex; flex-direction: column; }
    .form-group label { font-weight: 500; margin-bottom: 6px; }
    .form-group input, .form-group select, .form-group textarea { padding: 8px 10px; border: 1px solid #ccc; border-radius: 6px; }
    .collapsible { cursor: pointer; padding: 10px; background-color: #f1f1f1; border: none; border-radius: 6px; font-weight: 600; margin-bottom: 10px; width: 100%; text-align: left; }
    .content { display: none; }
    .content.active { display: block; }
    .table-responsive { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 10px; min-width: 900px; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background-color: #fafafa; }
    .actions { display: flex; justify-content: space-between; margin-bottom: 15px; }
    .btn-light-green { background-color: #d2f4dc; color: #2a8b3f; padding: 6px 14px; border: none; border-radius: 5px; cursor: pointer; font-weight: 500; }
    .btn-light-green:hover { background-color: #c3eecf; }
    .delete-btn { color: #d11a2a; background: none; border: none; font-size: 18px; cursor: pointer; }
    .attachments { padding: 20px; border: 2px dashed #ccc; text-align: center; color: #777; border-radius: 6px; cursor: pointer; position: relative; margin-bottom: 30px; }
    .attachments input[type="file"] { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
    .footer { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; margin-top: 30px; border-top: 1px solid #e0e0e0; padding-top: 20px; gap: 10px; }
    .btn { padding: 10px 20px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 14px; }
    .btn-cancel { background: #f5f5f5; color: #333; }
    .dropdown { position: relative; display: inline-block; }
    .dropdown .btn-green { background: #39B54B; color: #fff; }
    .dropdown-menu { display: none; position: absolute; right: 0; background: #fff; border: 1px solid #ccc; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 100; width: 160px; }
    .dropdown-menu button { width: 100%; padding: 10px 16px; background: none; border: none; text-align: left; cursor: pointer; white-space: nowrap; }
    .dropdown:hover .dropdown-menu { display: block; }
  </style>
</head>
<body>
  <a href="{% url 'expenses:expenses' %}" class="btn btn-lg" style="color: #39B54B;">← Back to Expense lists</a>

  <div class="container">
    <h2 class="title">{% if cheque %}Edit Cheque{% else %}Cheque Form{% endif %}</h2>

    <form method="post" enctype="multipart/form-data"
          action="{% if cheque %}{% url 'expenses:cheque-edit' cheque.id %}{% else %}{% url 'expenses:add-cheque' %}{% endif %}">
      {% csrf_token %}

      <!-- Top Fields -->
      <div class="section-wrapper">
        <div class="form-grid">
          <div class="form-group">
            <label>Payee</label>
            <select name="payee_supplier" id="supplier-select">
              <option value="">— Choose supplier —</option>
              {% for s in suppliers %}
                <option value="{{ s.id }}"
                        {% if cheque and cheque.payee_supplier_id == s.id %}selected{% endif %}>
                  {{ s.company_name }}
                </option>
              {% endfor %}
              <option value="add_new">➕ Add New</option>
            </select>
            <small>If supplier has unpaid bills, they will appear below (Pay Bills).</small>
            <small>Or enter name:</small>
            <input type="text" name="payee_name"
                   value="{% if cheque %}{{ cheque.payee_name }}{% endif %}"
                   placeholder="Free text (optional)">
          </div>

          <div class="form-group">
            <label>Bank Account</label>
            <select name="bank_account" required>
              {% for acc in bank_accounts %}
                <option value="{{ acc.id }}"
                        {% if cheque and cheque.bank_account_id == acc.id %}selected{% endif %}>
                  {{ acc.account_name }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label>Mailing Address</label>
            <input type="text" name="mailing_address"
                   value="{% if cheque %}{{ cheque.mailing_address }}{% endif %}"/>
          </div>

          <div class="form-group">
            <label>Payment Date</label>
            <input type="date" name="payment_date"
                   value="{% if cheque %}{{ cheque.payment_date|date:'Y-m-d' }}{% else %}{{ today|date:'Y-m-d' }}{% endif %}">
          </div>

          <div class="form-group">
            <label>Cheque No.</label>
            <input type="text" name="cheque_no"
                   value="{% if cheque %}{{ cheque.cheque_no }}{% else %}{{ generated_cheque_no }}{% endif %}"
                   readonly style="color: #39B54B; font-weight: 700;">
          </div>

          <div class="form-group">
            <label>Location</label>
            <input type="text" name="location"
                   value="{% if cheque %}{{ cheque.location }}{% endif %}">
          </div>
        </div>
      </div>

      <!-- ✅ Pay Bills -->
      <div class="section-wrapper">
        <button class="collapsible" type="button">Pay Bills (Unpaid Bills for Selected Supplier)</button>
        <div class="content active">
          <div class="table-responsive">
            <table>
              <thead>
                <tr>
                  <th>Bill No.</th>
                  <th>Bill Date</th>
                  <th>Due Date</th>
                  <th style="text-align:right;">Total</th>
                  <th style="text-align:right;">Balance</th>
                  <th style="width:180px;">Amount to Apply</th>
                </tr>
              </thead>
              <tbody id="bill-rows">
                {% if cheque and bill_prefill %}
                  {# ✅ Open Balance row (server-side prefill on edit) #}
                  {% if open_balance_value and open_balance_value > 0 %}
                    <tr>
                      <td colspan="4" style="font-weight:600;">Open Balance</td>
                      <td style="text-align:right;">{{ open_balance_value }}</td>
                      <td>
                        <input type="number" step="0.01"
                               name="open_balance_amount"
                               value="{{ open_balance_prefill|default:'0.00' }}"
                               max="{{ open_balance_value }}"
                               placeholder="0.00">
                      </td>
                    </tr>
                  {% endif %}

                  {% for b in bill_prefill %}
                    <tr>
                      <td>{{ b.bill_no }}</td>
                      <td>{% if b.bill_date %}{{ b.bill_date|date:'Y-m-d' }}{% else %}—{% endif %}</td>
                      <td>{% if b.due_date %}{{ b.due_date|date:'Y-m-d' }}{% else %}—{% endif %}</td>
                      <td style="text-align:right;">{{ b.total }}</td>
                      <td style="text-align:right;">{{ b.balance }}</td>
                      <td>
                        <input type="number" step="0.01"
                               name="amount_paid_{{ b.id }}"
                               value="{{ b.applied }}"
                               max="{{ b.balance }}"
                               placeholder="0.00">
                      </td>
                    </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="6" style="text-align:center; color:#888;">
                      Select a supplier to load unpaid bills…
                    </td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>

          <small style="color:#666;">
            If you enter amounts here, cheque will post as: <b>DR Accounts Payable, CR Bank</b>.
            If no bills, use Category/Item sections to record direct expenses.
          </small>
        </div>
      </div>

      <!-- Category Details -->
      <div class="section-wrapper">
        <button class="collapsible" type="button">Category Details</button>
        <div class="content {% if cat_lines %}active{% endif %}">
          <div class="table-responsive">
            <table id="categoryTable">
              <thead>
                <tr><th>#</th><th>Category</th><th>Description</th><th>Amount</th><th>Billable</th><th>Customer / Project</th><th>Class</th><th>Operations</th></tr>
              </thead>
              <tbody>
                {% if cat_lines %}
                  {% for row in cat_lines %}
                  <tr>
                    <td></td>
                    <td>
                      <select name="cat_category[]">
                        <option value="">-- Select --</option>
                        {% for acc in expense_accounts %}
                          <option value="{{ acc.id }}" {% if row.category_id == acc.id %}selected{% endif %}>
                            {{ acc.account_name }}
                          </option>
                        {% endfor %}
                      </select>
                    </td>
                    <td><input type="text" name="cat_desc[]" value="{{ row.description }}"></td>
                    <td><input type="number" step="0.01" name="cat_amount[]" value="{{ row.amount }}"></td>
                    <td><input type="checkbox" name="cat_billable[]" value="{{ forloop.counter0 }}" {% if row.is_billable %}checked{% endif %}></td>
                    <td>
                      <select name="cat_customer[]">
                        <option value="">-- Customer/Project --</option>
                        {% for c in customers %}
                          <option value="{{ c.id }}" {% if row.customer_id == c.id %}selected{% endif %}>{{ c.customer_name }}</option>
                        {% endfor %}
                        <option value="add_new">➕ Add New</option>
                      </select>
                    </td>
                    <td>
                      <select name="cat_class[]">
                        <option value="">-- Class --</option>
                        {% for cl in classes %}
                          <option value="{{ cl.id }}" {% if row.class_field_id == cl.id %}selected{% endif %}>{{ cl.class_name }}</option>
                        {% endfor %}
                        <option value="add_new">➕ Add New</option>
                      </select>
                    </td>
                    <td><button class="delete-btn" type="button" onclick="deleteRow(this)"><i class='bx bx-trash'></i></button></td>
                  </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td></td>
                    <td>
                      <select name="cat_category[]">
                        <option value="">-- Select --</option>
                        {% for acc in expense_accounts %}
                          <option value="{{ acc.id }}">{{ acc.account_name }}</option>
                        {% endfor %}
                      </select>
                    </td>
                    <td><input type="text" name="cat_desc[]"/></td>
                    <td><input type="number" step="0.01" name="cat_amount[]"/></td>
                    <td><input type="checkbox" name="cat_billable[]" value="0"/></td>
                    <td>
                      <select name="cat_customer[]">
                        <option value="">-- Customer/Project --</option>
                        {% for c in customers %}
                          <option value="{{ c.id }}">{{ c.customer_name }}</option>
                        {% endfor %}
                        <option value="add_new">➕ Add New</option>
                      </select>
                    </td>
                    <td>
                      <select name="cat_class[]">
                        <option value="">-- Class --</option>
                        {% for cl in classes %}
                          <option value="{{ cl.id }}">{{ cl.class_name }}</option>
                        {% endfor %}
                        <option value="add_new">➕ Add New</option>
                      </select>
                    </td>
                    <td><button class="delete-btn" type="button" onclick="deleteRow(this)"><i class='bx bx-trash'></i></button></td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
          <div class="actions">
            <button class="btn-light-green" type="button" onclick="addCategoryRow()">Add Line</button>
            <button class="btn-light-green" type="button" onclick="clearCategoryTable()">Clear All</button>
          </div>
        </div>
      </div>

      <!-- Item Details -->
      <div class="section-wrapper">
        <button class="collapsible" type="button">Item Details</button>
        <div class="content {% if item_lines %}active{% endif %}">
          <div class="table-responsive">
            <table id="itemTable">
              <thead>
                <tr><th>#</th><th>Product / Service</th><th>Description</th><th>Qty</th><th>Rate</th><th>Amount</th><th>Billable</th><th>Customer / Project</th><th>Class</th><th>Operations</th></tr>
              </thead>
              <tbody>
                {% if item_lines %}
                  {% for row in item_lines %}
                  <tr>
                    <td></td>
                    <td>
                      <select name="item_product[]">
                        <option value="">-- Select --</option>
                        {% for p in products %}
                          <option value="{{ p.id }}" {% if row.product_id == p.id %}selected{% endif %}>{{ p.name }}</option>
                        {% endfor %}
                        <option value="add_new">➕ Add New</option>
                      </select>
                    </td>
                    <td><input type="text" name="item_desc[]" value="{{ row.description }}"/></td>
                    <td><input type="number" step="0.01" name="item_qty[]" value="{{ row.qty }}"/></td>
                    <td><input type="number" step="0.01" name="item_rate[]" value="{{ row.rate }}"/></td>
                    <td><input type="number" step="0.01" name="item_amount[]" value="{{ row.amount }}"/></td>
                    <td><input type="checkbox" name="item_billable[]" value="{{ forloop.counter0 }}" {% if row.is_billable %}checked{% endif %}/></td>
                    <td>
                      <select name="item_customer[]">
                        <option value="">-- Customer/Project --</option>
                        {% for c in customers %}
                          <option value="{{ c.id }}" {% if row.customer_id == c.id %}selected{% endif %}>{{ c.customer_name }}</option>
                        {% endfor %}
                        <option value="add_new">➕ Add New</option>
                      </select>
                    </td>
                    <td>
                      <select name="item_class[]">
                        <option value="">-- Class --</option>
                        {% for cl in classes %}
                          <option value="{{ cl.id }}" {% if row.class_field_id == cl.id %}selected{% endif %}>{{ cl.class_name }}</option>
                        {% endfor %}
                        <option value="add_new">➕ Add New</option>
                      </select>
                    </td>
                    <td><button class="delete-btn" type="button" onclick="deleteRow(this)"><i class='bx bx-trash'></i></button></td>
                  </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td></td>
                    <td>
                      <select name="item_product[]">
                        <option value="">-- Select --</option>
                        {% for p in products %}
                          <option value="{{ p.id }}">{{ p.name }}</option>
                        {% endfor %}
                        <option value="add_new">➕ Add New</option>
                      </select>
                    </td>
                    <td><input type="text" name="item_desc[]"/></td>
                    <td><input type="number" step="0.01" name="item_qty[]"/></td>
                    <td><input type="number" step="0.01" name="item_rate[]"/></td>
                    <td><input type="number" step="0.01" name="item_amount[]"/></td>
                    <td><input type="checkbox" name="item_billable[]" value="0"/></td>
                    <td>
                      <select name="item_customer[]">
                        <option value="">-- Customer/Project --</option>
                        {% for c in customers %}
                          <option value="{{ c.id }}">{{ c.customer_name }}</option>
                        {% endfor %}
                        <option value="add_new">➕ Add New</option>
                      </select>
                    </td>
                    <td>
                      <select name="item_class[]">
                        <option value="">-- Class --</option>
                        {% for cl in classes %}
                          <option value="{{ cl.id }}">{{ cl.class_name }}</option>
                        {% endfor %}
                        <option value="add_new">➕ Add New</option>
                      </select>
                    </td>
                    <td><button class="delete-btn" type="button" onclick="deleteRow(this)"><i class='bx bx-trash'></i></button></td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
          <div class="actions">
            <button class="btn-light-green" type="button" onclick="addItemRow()">Add Line</button>
            <button class="btn-light-green" type="button" onclick="clearItemTable()">Clear All</button>
          </div>
        </div>
      </div>

      <!-- Memo -->
      <div class="form-group" style="margin-bottom: 30px;">
        <label>Memo</label>
        <textarea rows="3" style="width:100%" name="memo">{% if cheque %}{{ cheque.memo }}{% endif %}</textarea>
      </div>

      <!-- Attachments -->
      <div class="attachments">
        {% if cheque and cheque.attachments %}
          <p>Existing file:
            <a href="{{ cheque.attachments.url }}" target="_blank">
              {{ cheque.attachments.name|cut:'attachments/' }}
            </a>
          </p>
        {% endif %}
        <input type="file" name="attachments" multiple />
        <i class='bx bx-upload' style="font-size: 30px;"></i>
        <p>Drag/Drop files here or click to upload (Max size: 20MB)</p>
      </div>

      <!-- Footer Buttons -->
      <div class="footer">
        <a href="{% url 'expenses:expenses' %}" class="btn btn-cancel">Cancel</a>
        <div class="dropdown">
          <button type="button" class="btn btn-green">Save ▼</button>
          <div class="dropdown-menu">
            <button type="submit" name="save_action" value="save">Save</button>
            <button type="submit" name="save_action" value="save&new">Save & New</button>
            <button type="submit" name="save_action" value="save&close">Save & Close</button>
          </div>
        </div>
      </div>
    </form>
  </div>

  <script>
  const ADD_SUPPLIER_URL = "{% url 'sowaf:add-supplier' %}";
  const ADD_CUSTOMER_URL = "{% url 'sowaf:add-customer' %}";
  const ADD_PRODUCT_URL  = "{% url 'inventory:add-products' %}";
  const ADD_CLASS_AJAX_URL = "{% url 'inventory:add_class_ajax' %}";
  const OUTSTANDING_BILLS_URL = "{% url 'expenses:outstanding_bills_api' %}";

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function openAddSupplier(selectEl){ window.open(ADD_SUPPLIER_URL, "_blank", "noopener"); selectEl.value = ""; }
  function openAddCustomer(selectEl){ window.open(ADD_CUSTOMER_URL, "_blank", "noopener"); selectEl.value = ""; }
  function openAddProduct(selectEl){ window.open(ADD_PRODUCT_URL, "_blank", "noopener"); selectEl.value = ""; }

  function addNewClassInline(selectEl){
    const name = (prompt("Enter new class name:") || "").trim();
    if(!name){ selectEl.value = ""; return; }

    fetch(ADD_CLASS_AJAX_URL, {
      method: "POST",
      headers: {
        "X-CSRFToken": getCookie("csrftoken"),
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: "name=" + encodeURIComponent(name)
    })
    .then(res => res.json())
    .then(data => {
      if(data && data.success){
        const opt = document.createElement("option");
        opt.value = data.id;
        opt.textContent = data.name;
        opt.selected = true;
        selectEl.appendChild(opt);
        selectEl.value = String(data.id);
      } else {
        alert((data && data.error) ? data.error : "Failed to add class");
        selectEl.value = "";
      }
    })
    .catch(() => {
      alert("Network error. Try again.");
      selectEl.value = "";
    });
  }

  // supplier dropdown "+ Add New" + load bills + open balance row
  (function(){
    const sel = document.getElementById('supplier-select');
    const tbody = document.getElementById('bill-rows');

    if (!sel) return;

    sel.addEventListener('change', function(){
      if (this.value === 'add_new'){ openAddSupplier(this); return; }

      // clear bills if no supplier
      if (!this.value) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:#888;">Select a supplier to load unpaid bills…</td></tr>`;
        return;
      }

      tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:#888;">Loading…</td></tr>`;
      const url = OUTSTANDING_BILLS_URL + "?supplier=" + encodeURIComponent(this.value);

      fetch(url, { headers: { 'Accept': 'application/json' }, credentials: 'same-origin' })
        .then(res => { if(!res.ok) throw new Error("HTTP " + res.status); return res.json(); })
        .then(data => {
          const bills = data.bills || [];
          const openBal = Number(data.open_balance || 0);

          let rows = "";

          // ✅ Open Balance row (only if > 0)
          if (openBal > 0) {
            rows += `
              <tr>
                <td colspan="4" style="font-weight:600;">Open Balance</td>
                <td style="text-align:right;">${fmt(openBal)}</td>
                <td>
                  <input type="number" step="0.01"
                         name="open_balance_amount"
                         max="${openBal}"
                         placeholder="0.00">
                </td>
              </tr>
            `;
          }

          if (!bills.length) {
            if (!rows) {
              tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:#888;">No unpaid bills for this supplier.</td></tr>`;
              return;
            }
            tbody.innerHTML = rows;
            return;
          }

          rows += bills.map(b => `
            <tr>
              <td>${escapeHtml(b.bill_no || b.id)}</td>
              <td>${b.bill_date ?? '—'}</td>
              <td>${b.due_date ?? '—'}</td>
              <td style="text-align:right;">${fmt(b.total)}</td>
              <td style="text-align:right;">${fmt(b.balance)}</td>
              <td>
                <input type="number" step="0.01"
                       name="amount_paid_${b.id}"
                       max="${b.balance}"
                       placeholder="0.00">
              </td>
            </tr>
          `).join('');

          tbody.innerHTML = rows;
        })
        .catch(() => {
          tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:#c00;">Failed to load bills.</td></tr>`;
        });
    });

    function fmt(x){
      const n = Number(x);
      if (Number.isNaN(n)) return x;
      return n.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
    }
  })();

  // collapsibles
  document.querySelectorAll(".collapsible").forEach(btn => {
    btn.addEventListener("click", () => btn.nextElementSibling.classList.toggle("active"));
  });

  // row ops
  function deleteRow(btn){
    const tb = btn.closest("tbody");
    btn.closest("tr").remove();
    renumber(tb);
  }
  function renumber(tbody){
    [...tbody.querySelectorAll("tr")].forEach((tr,i)=> tr.cells[0].textContent = i+1);
    tbody.querySelectorAll('input[type="checkbox"]').forEach((cb, i)=> cb.value = i);
  }

  function addCategoryRow() {
    const tbody = document.querySelector("#categoryTable tbody");
    const tr = tbody.insertRow();
    tr.innerHTML = `
      <td></td>
      <td>
        <select name="cat_category[]">
          <option value="">-- Select --</option>
          {% for acc in expense_accounts %}
            <option value="{{ acc.id }}">{{ acc.account_name }}</option>
          {% endfor %}
        </select>
      </td>
      <td><input type="text" name="cat_desc[]"/></td>
      <td><input type="number" step="0.01" name="cat_amount[]"/></td>
      <td><input type="checkbox" name="cat_billable[]" value="0"/></td>
      <td>
        <select name="cat_customer[]">
          <option value="">-- Customer/Project --</option>
          {% for c in customers %}
            <option value="{{ c.id }}">{{ c.customer_name }}</option>
          {% endfor %}
          <option value="add_new">➕ Add New</option>
        </select>
      </td>
      <td>
        <select name="cat_class[]">
          <option value="">-- Class --</option>
          {% for cl in classes %}
            <option value="{{ cl.id }}">{{ cl.class_name }}</option>
          {% endfor %}
          <option value="add_new">➕ Add New</option>
        </select>
      </td>
      <td><button class="delete-btn" type="button" onclick="deleteRow(this)"><i class='bx bx-trash'></i></button></td>
    `;
    renumber(tbody);
  }
  function clearCategoryTable(){ document.querySelector("#categoryTable tbody").innerHTML=""; }

  function addItemRow() {
    const tbody = document.querySelector("#itemTable tbody");
    const tr = tbody.insertRow();
    tr.innerHTML = `
      <td></td>
      <td>
        <select name="item_product[]">
          <option value="">-- Select --</option>
          {% for p in products %}
            <option value="{{ p.id }}">{{ p.name }}</option>
          {% endfor %}
          <option value="add_new">➕ Add New</option>
        </select>
      </td>
      <td><input type="text" name="item_desc[]"/></td>
      <td><input type="number" step="0.01" name="item_qty[]"/></td>
      <td><input type="number" step="0.01" name="item_rate[]"/></td>
      <td><input type="number" step="0.01" name="item_amount[]"/></td>
      <td><input type="checkbox" name="item_billable[]" value="0"/></td>
      <td>
        <select name="item_customer[]">
          <option value="">-- Customer/Project --</option>
          {% for c in customers %}
            <option value="{{ c.id }}">{{ c.customer_name }}</option>
          {% endfor %}
          <option value="add_new">➕ Add New</option>
        </select>
      </td>
      <td>
        <select name="item_class[]">
          <option value="">-- Class --</option>
          {% for cl in classes %}
            <option value="{{ cl.id }}">{{ cl.class_name }}</option>
          {% endfor %}
          <option value="add_new">➕ Add New</option>
        </select>
      </td>
      <td><button class="delete-btn" type="button" onclick="deleteRow(this)"><i class='bx bx-trash'></i></button></td>
    `;
    renumber(tbody);
  }
  function clearItemTable(){ document.querySelector("#itemTable tbody").innerHTML=""; }

  // dynamic "add new"
  document.addEventListener("change", function(e){
    const el = e.target;
    if(!el || el.tagName !== "SELECT") return;

    const name = el.getAttribute("name") || "";
    const val  = el.value;

    if(name === "cat_customer[]" && val === "add_new"){ openAddCustomer(el); return; }
    if(name === "cat_class[]" && val === "add_new"){ addNewClassInline(el); return; }

    if(name === "item_product[]" && val === "add_new"){ openAddProduct(el); return; }
    if(name === "item_customer[]" && val === "add_new"){ openAddCustomer(el); return; }
    if(name === "item_class[]" && val === "add_new"){ addNewClassInline(el); return; }
  });

  window.addEventListener("load", () => {
    renumber(document.querySelector("#categoryTable tbody"));
    renumber(document.querySelector("#itemTable tbody"));
  });
  </script>
</body>
</html>
