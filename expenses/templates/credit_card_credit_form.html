{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Credit Card Credit</title>
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet"/>
   <link rel="icon" type="image/x-icon" href="{% static 'sowaf/images/favicon.ico' %}">
  <link rel="stylesheet" href="{% static 'sowaf/styles/style.css' %}" />
  <link rel="stylesheet" href="{% static 'sowaf/styles/bootsrap.min.css' %}" />
  <style>
    /* same styling you had, trimmed a bit */
    *{box-sizing:border-box;margin:0;padding:0;font-family:"Poppins",sans-serif;font-size:14px;}
    body{background:#f4f6f8;padding:30px;}
    .container{background:#fff;padding:25px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.08);width:90%;margin:auto;}
    h2.title{text-align:center;color:#39B54B;margin-bottom:25px;font-size:28px;font-weight:700;}
    .section-wrapper{background:#f9f9f9;padding:20px;border-radius:10px;margin-bottom:25px;box-shadow:0 1px 3px rgba(0,0,0,.05);}
    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:20px;}
    .form-group{display:flex;flex-direction:column;}
    .form-group label{font-weight:500;margin-bottom:6px;}
    .form-group input,.form-group select,.form-group textarea{padding:8px 10px;border:1px solid #ccc;border-radius:6px;}
    .collapsible{cursor:pointer;padding:10px;background:#f1f1f1;border:none;border-radius:6px;font-weight:600;margin-bottom:10px;}
    .content{display:none;}
    .content.active{display:block;}
    table{width:100%;border-collapse:collapse;margin-bottom:10px;}
    th,td{border:1px solid #ddd;padding:8px;}
    th{background:#fafafa;}
    .actions{display:flex;justify-content:space-between;margin-bottom:15px;}
    .btn-light-green{background:#d2f4dc;color:#2a8b3f;padding:6px 14px;border:none;border-radius:5px;cursor:pointer;font-weight:500;}
    .delete-btn{color:red;background:none;border:none;font-size:16px;cursor:pointer;}
    .attachments{padding:20px;border:2px dashed #ccc;text-align:center;color:#777;border-radius:6px;cursor:pointer;position:relative;margin-bottom:30px;}
    .attachments input[type="file"]{position:absolute;top:0;left:0;width:100%;height:100%;opacity:0;cursor:pointer;}
    .footer{display:flex;justify-content:space-between;flex-wrap:wrap;margin-top:30px;border-top:1px solid #e0e0e0;padding-top:20px;}
    .btn{padding:10px 20px;border:none;border-radius:6px;font-weight:bold;cursor:pointer;}
    .btn-cancel{background:#f5f5f5;color:#333;text-decoration:none;}
    .btn-green{background:#39B54B;color:#fff;}
    .total-box{text-align:right;font-weight:bold;margin-top:10px;}
    .dropdown{position:relative;display:inline-block;}
    .dropdown-menu{display:none;position:absolute;right:0;background:#fff;border:1px solid #ccc;border-radius:4px;box-shadow:0 2px 8px rgba(0,0,0,.1);z-index:100;width:160px;}
    .dropdown-menu button{width:100%;padding:8px 14px;background:none;border:none;text-align:left;cursor:pointer;}
    .dropdown:hover .dropdown-menu{display:block;}
  </style>
</head>
<body>
  <div class="container">
    <a href="{% url 'expenses:expenses' %}" style="color:#39B54B;text-decoration:none;">← Back to All Expenses</a>

    <h2 class="title">Credit Card Credit</h2>

    <form method="post" enctype="multipart/form-data"
          action="{% if credit %}{% url 'expenses:credit-card-credit-edit' credit.id %}{% else %}{% url 'expenses:credit-card' %}{% endif %}">
      {% csrf_token %}

      <!-- Top Fields -->
      <div class="section-wrapper">
        <div class="form-grid">
          <div class="form-group">
            <label>Payee</label>
            <select name="payee_supplier">
              <option value="">Choose a payee</option>
              {% for s in suppliers %}
                <option value="{{ s.id }}" {% if credit and credit.payee_supplier_id == s.id %}selected{% endif %}>
                  {{ s.company_name }}
                </option>
              {% endfor %}
            </select>
            <small>Or enter name:</small>
            <input type="text" name="payee_name"
                   value="{% if credit %}{{ credit.payee_name }}{% endif %}"
                   placeholder="Payee name (optional)">
          </div>

         <div class="form-group">
  <label>Deposit to / Credit card account</label>
  <select name="credit_card" required>
    <option value="">Choose account</option>
    {% for acc in deposit_accounts %}
      <option value="{{ acc.id }}" {% if credit and credit.credit_card_id == acc.id %}selected{% endif %}>
        {{ acc.account_name }}
      </option>
    {% endfor %}
  </select>
</div>

          <div class="form-group">
            <label>Credit Date</label>
            <input type="date" name="credit_date"
                   value="{% if credit %}{{ credit.credit_date|date:'Y-m-d' }}{% else %}{{ today|date:'Y-m-d' }}{% endif %}">
          </div>

          <div class="form-group">
            <label>Ref No.</label>
            <input type="text" name="ref_no"
                   value="{% if credit %}{{ credit.ref_no }}{% else %}{{ ref_no }}{% endif %}">
          </div>

          <div class="form-group">
            <label>Location</label>
            <input type="text" name="location"
                   value="{% if credit %}{{ credit.location }}{% endif %}">
          </div>

          <div class="form-group">
            <label>Tags</label>
            <input type="text" name="tags"
                   placeholder="Start typing to add a tag"
                   value="{% if credit %}{{ credit.tags }}{% endif %}">
          </div>
        </div>
      </div>

      <!-- Category Details -->
      <div class="section-wrapper">
        <button type="button" class="collapsible">Category Details</button>
        <div class="content" id="category-section">
          <table id="category-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Category</th>
                <th>Description</th>
                <th>Amount</th>
                <th>Billable</th>
                <th>Customer/Project</th>
                <th>Class</th>
                <th>Delete</th>
              </tr>
            </thead>
            <tbody>
              {% if credit %}
                {% for line in credit.category_lines.all %}
                  <tr>
                    <td></td>
                    <td>
                      <select name="cat_category[]">
                        <option value="">-- choose --</option>
                        {% for acc in expense_accounts %}
                          <option value="{{ acc.id }}" {% if line.category_id == acc.id %}selected{% endif %}>
                            {{ acc.account_name }}
                          </option>
                        {% endfor %}
                      </select>
                    </td>
                    <td><input type="text" name="cat_description[]" value="{{ line.description }}"></td>
                    <td><input type="number" step="0.01" class="amount" name="cat_amount[]" value="{{ line.amount }}" oninput="updateTotal()"></td>
                    <td style="text-align:center;">
                      <input type="checkbox" name="cat_billable[]" {% if line.billable %}checked{% endif %}>
                    </td>
                    <td>
                      <select name="cat_customer[]">
                        <option value="">—</option>
                        {% for c in customers %}
                          <option value="{{ c.id }}" {% if line.customer_id == c.id %}selected{% endif %}>
                            {{ c.customer_name }}
                          </option>
                        {% endfor %}
                      </select>
                    </td>
                    <td>
                      <select name="cat_class[]">
                        <option value="">—</option>
                        {% for cl in classes %}
                          <option value="{{ cl.id }}" {% if line.pclass_id == cl.id %}selected{% endif %}>
                            {{ cl.class_name }}
                          </option>
                        {% endfor %}
                      </select>
                    </td>
                    <td><button type="button" class="delete-btn" onclick="deleteRow(this)">×</button></td>
                  </tr>
                {% endfor %}
              {% endif %}
            </tbody>
          </table>
          <div class="actions">
            <button type="button" class="btn-light-green" onclick="addRow('category')">Add Line</button>
            <button type="button" class="btn-light-green" onclick="clearTable('category')">Clear All</button>
          </div>
        </div>
      </div>

      <!-- Item Details (structure ready; GL/inventory later) -->
      <div class="section-wrapper">
        <button type="button" class="collapsible">Item Details</button>
        <div class="content" id="item-section">
          <table id="item-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Product/Service</th>
                <th>Description</th>
                <th>Qty</th>
                <th>Rate</th>
                <th>Amount</th>
                <th>Billable</th>
                <th>Customer/Project</th>
                <th>Class</th>
                <th>Delete</th>
              </tr>
            </thead>
            <tbody>
  {% if credit %}
    {% for line in credit.item_lines.all %}
      <tr>
        <td></td>
        <!-- Product -->
        <td>
          <select name="item_product[]">
            <option value="">--select--</option>
            {% for p in products %}
              <option value="{{ p.id }}" {% if line.product_id == p.id %}selected{% endif %}>
                {{ p.name }}
              </option>
            {% endfor %}
          </select>
        </td>
        <!-- Description -->
        <td>
          <input type="text" name="item_description[]" value="{{ line.description }}">
        </td>
        <!-- Qty -->
        <td>
          <input type="number" step="0.01" name="item_qty[]"
                 value="{{ line.quantity }}" oninput="recalcRow(this);">
        </td>
        <!-- Rate -->
        <td>
          <input type="number" step="0.01" name="item_rate[]"
                 value="{{ line.rate }}" oninput="recalcRow(this);">
        </td>
        <!-- Amount -->
        <td>
          <input type="number" step="0.01" class="amount" name="item_amount[]"
                 value="{{ line.amount }}" oninput="updateTotal();">
        </td>
        <!-- Billable -->
        <td style="text-align:center;">
          <input type="checkbox" name="item_billable[]" {% if line.billable %}checked{% endif %}>
        </td>
        <!-- Customer/Project -->
        <td>
          <select name="item_customer[]">
            <option value="">—</option>
            {% for c in customers %}
              <option value="{{ c.id }}" {% if line.customer_id == c.id %}selected{% endif %}>
                {{ c.customer_name }}
              </option>
            {% endfor %}
          </select>
        </td>
        <!-- Class -->
        <td>
          <select name="item_class[]">
            <option value="">—</option>
            {% for cl in classes %}
              <option value="{{ cl.id }}" {% if line.pclass_id == cl.id %}selected{% endif %}>
                {{ cl.class_name }}
              </option>
            {% endfor %}
          </select>
        </td>
        <!-- Delete -->
        <td>
          <button type="button" class="delete-btn" onclick="deleteRow(this)">×</button>
        </td>
      </tr>
    {% endfor %}
  {% endif %}
</tbody>

          </table>
          <div class="actions">
            <button type="button" class="btn-light-green" onclick="addRow('item')">Add Line</button>
            <button type="button" class="btn-light-green" onclick="clearTable('item')">Clear All</button>
          </div>
        </div>
      </div>

      <!-- Total -->
      <div class="total-box">
        Total: <span id="totalAmount">
        {% if credit %}{{ credit.total_amount }}{% else %}0.00{% endif %}
        </span>
      </div>

      <!-- Memo -->
      <div class="form-group" style="margin-top: 30px;">
        <label>Memo</label>
        <textarea rows="3" style="width:100%" name="memo">{% if credit %}{{ credit.memo }}{% endif %}</textarea>
      </div>

      <!-- Attachments -->
      <div class="attachments">
        {% if credit and credit.attachments %}
          <p>Existing file: <a href="{{ credit.attachments.url }}" target="_blank">Download</a></p>
        {% endif %}
        <input type="file" name="attachments" multiple />
        <i class='bx bx-upload' style="font-size: 30px;"></i>
        <p>Drag/Drop files here or click to upload (Max size: 20MB)</p>
      </div>

      <!-- Footer Buttons -->
      <div class="footer">
        <a href="{% url 'expenses:expenses' %}" class="btn btn-cancel">Cancel</a>

        <div class="dropdown">
          <button type="button" class="btn btn-green">Save ▼</button>
          <div class="dropdown-menu">
            <button type="submit" name="save_action" value="save">Save</button>
            <button type="submit" name="save_action" value="save&new">Save &amp; New</button>
            <button type="submit" name="save_action" value="save&close">Save &amp; Close</button>
          </div>
        </div>
      </div>
    </form>
  </div>

  <script src="{% static 'sowaf/styles/script.js' %}"></script>
  <script>
    // Collapsible sections
    document.querySelectorAll(".collapsible").forEach(btn => {
      btn.addEventListener("click", () => {
        const content = btn.nextElementSibling;
        content.classList.toggle("active");
      });
    });

    function addRow(type){
      const table = document.querySelector(`#${type}-table tbody`);
      const row   = document.createElement("tr");

      if (type === "category"){
        row.innerHTML = `
          <td></td>
          <td>
            <select name="cat_category[]">
              <option value="">-- choose --</option>
              {% for acc in expense_accounts %}
                <option value="{{ acc.id }}">{{ acc.account_name }}</option>
              {% endfor %}
            </select>
          </td>
          <td><input type="text" name="cat_description[]"></td>
          <td><input type="number" step="0.01" class="amount" name="cat_amount[]" oninput="updateTotal()"></td>
          <td style="text-align:center;">
            <input type="checkbox" name="cat_billable[]">
          </td>
          <td>
            <select name="cat_customer[]">
              <option value="">—</option>
              {% for c in customers %}
                <option value="{{ c.id }}">{{ c.customer_name }}</option>
              {% endfor %}
            </select>
          </td>
          <td>
            <select name="cat_class[]">
              <option value="">—</option>
              {% for cl in classes %}
                <option value="{{ cl.id }}">{{ cl.class_name }}</option>
              {% endfor %}
            </select>
          </td>
          <td><button type="button" class="delete-btn" onclick="deleteRow(this)">×</button></td>
        `;
      } else {
  row.innerHTML = `
    <td></td>
    <!-- Product -->
    <td>
      <select name="item_product[]">
        <option value="">--select--</option>
        {% for p in products %}
          <option value="{{ p.id }}">{{ p.name }}</option>
        {% endfor %}
      </select>
    </td>
    <!-- Description -->
    <td><input type="text" name="item_description[]"></td>
    <!-- Qty -->
    <td><input type="number" step="0.01" name="item_qty[]" oninput="recalcRow(this);"></td>
    <!-- Rate -->
    <td><input type="number" step="0.01" name="item_rate[]" oninput="recalcRow(this);"></td>
    <!-- Amount -->
    <td><input type="number" step="0.01" class="amount" name="item_amount[]" oninput="updateTotal();"></td>
    <!-- Billable -->
    <td style="text-align:center;">
      <input type="checkbox" name="item_billable[]">
    </td>
    <!-- Customer/Project -->
    <td>
      <select name="item_customer[]">
        <option value="">—</option>
        {% for c in customers %}
          <option value="{{ c.id }}">{{ c.customer_name }}</option>
        {% endfor %}
      </select>
    </td>
    <!-- Class -->
    <td>
      <select name="item_class[]">
        <option value="">—</option>
        {% for cl in classes %}
          <option value="{{ cl.id }}">{{ cl.class_name }}</option>
        {% endfor %}
      </select>
    </td>
    <!-- Delete -->
    <td><button type="button" class="delete-btn" onclick="deleteRow(this)">×</button></td>
  `;
}


      table.appendChild(row);
      renumber(table);
      updateTotal();
    }

    function deleteRow(btn){
      const tableBody = btn.closest("tbody");
      btn.closest("tr").remove();
      renumber(tableBody);
      updateTotal();
    }

    function clearTable(type){
      const tbody = document.querySelector(`#${type}-table tbody`);
      tbody.innerHTML = "";
      updateTotal();
    }

    function renumber(tbody){
      Array.from(tbody.querySelectorAll("tr")).forEach((row, idx) => {
        row.cells[0].textContent = idx + 1;
      });
    }

    function updateTotal(){
      let total = 0;
      document.querySelectorAll(".amount").forEach(input => {
        const val = parseFloat(input.value);
        if (!isNaN(val)) total += val;
      });
      document.getElementById("totalAmount").textContent = total.toFixed(2);
    }

    document.addEventListener("DOMContentLoaded", function(){
      document.querySelectorAll("#category-table tbody,#item-table tbody").forEach(tbody => renumber(tbody));
      updateTotal();
    });

    function recalcRow(el){
  const row  = el.closest("tr");
  const qty  = parseFloat(row.querySelector("input[name='item_qty[]']").value)  || 0;
  const rate = parseFloat(row.querySelector("input[name='item_rate[]']").value) || 0;
  const amt  = row.querySelector("input[name='item_amount[]']");
  if (amt){
    amt.value = (qty * rate).toFixed(2);
  }
  updateTotal();
}

  </script>
</body>
</html>
