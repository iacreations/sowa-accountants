{% load static %}
{% load humanize %}

{% include 'includes/navbar.html' %}

<style>
/* tabs */
.tabs { display:inline-flex; border:1px solid #ddd; border-radius:8px; overflow:hidden; margin: 12px 0 20px; }
.tab { padding:10px 20px; font-size:14px; font-weight:500; color:#555; text-decoration:none; background:#f9f9f9; border-right:1px solid #ddd; transition:all .2s; }
.tab:last-child { border-right:none; }
.tab:hover { background:#f1f1f1; }
.tab.active { background:#39B54B; color:#fff; }

/* action dropdown */
.action-wrapper { display:flex; align-items:center; gap:6px; position:relative; }
.edit-link { color:#39B54B; font-weight:500; text-decoration:none; }
.dropdown { position:relative; cursor:pointer; }
.dropdown i { font-size:18px; color:#444; }
.dropdown-menu { display:none; position:absolute; right:0; background:#fff; border:1px solid #ddd; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,.15); min-width:150px; z-index:10; }
.dropdown-menu a { display:block; padding:8px 12px; font-size:14px; color:#333; text-decoration:none; }
.dropdown-menu a:hover { background:#f4f6f8; }
.dropdown:hover .dropdown-menu { display:block; }

/* inactive look */
.inactive-row { color:#888; background:#f9f9f9; font-style:italic; }
.edit-link.disabled { pointer-events:none; opacity:.5; }

.tab {
  display: flex;
  align-items: center;
  gap: 6px;
}

.badge {
  background: #eee;
  color: #333;
  font-size: 12px;
  padding: 2px 8px;
  border-radius: 12px;
}
.tab.active .badge {
  background: #fff;
  color: #39B54B;
}

/* modal */
#customizeModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.5); justify-content:center; align-items:center; z-index:999; }
.modal-card { background:#fff; padding:20px; border-radius:12px; width:420px; max-width:90%; box-shadow:0 8px 24px rgba(0,0,0,.2); }
.modal-card h4 { margin:0 0 12px; color:#39B54B; }
.modal-actions { display:flex; justify-content:flex-end; gap:8px; margin-top:14px; }
.btn { padding:8px 14px; border:none; border-radius:6px; cursor:pointer; }
.btn-outline { background:#fff; border:1px solid #ddd; }
.btn-primary { background:#39B54B; color:#fff; }

/* child indent */
.child-row .indent {
  margin-left: 20px;
  padding-left: 5px;
  border-left: 4px dashed #39B54B;
  font-style: italic;
  color: #39B54B;
}

/* Level-1 heading row */
.level1-row td {
  background:#e9fbef;
  font-weight:800;
  color:#0f5132;
  text-transform:uppercase;
}

/* empty text inside category */
.empty-row td {
  font-style:italic;
  color:#6b7280;
  background:#f9fff9;
}
</style>

{% include 'includes/sidebar.html' %}

<div class="main_body" id="main_body" style="margin-top: 5%;">
  <div class="d-flex align-items-center justify-content-between mb-2">
    <div>
      <h1 class="text-success">Chart Of Accounts</h1>
      <p class="text-muted text-center" style="text-align: center;">
        Organise and manage your accounts.
      </p>
    </div>

    <button type="button" id="customizeBtn" class="button">
      âš™ Customize
    </button>
  </div>

  <!-- top mini menu -->
  <div class="text-center mb-3">
    <ul class="d-flex" style="list-style:none; justify-content:center; gap:16px; padding-left:0;">
      <li><a href="#" class="btn button" style="text-decoration:none;color: #e9fbef">Import</a></li>
      <li><a href="{% url 'accounts:add-account' %}" class="btn button" style="text-decoration:none; color: #e9fbef;">Add account</a></li>
    </ul>
  </div>

  <h3 class="text-center" style="color: #39B54B; font-weight: 800;">Account Lists</h3>

  <!-- tabs -->
  <div class="tabs">
    <a href="?status=active" class="tab {% if status == 'active' %}active{% endif %}">
      Active <span class="badge">{{ active_count }}</span>
    </a>
    <a href="?status=inactive" class="tab {% if status == 'inactive' %}active{% endif %}">
      Inactive <span class="badge">{{ inactive_count }}</span>
    </a>
    <a href="?status=all" class="tab {% if status == 'all' %}active{% endif %}">
      All <span class="badge">{{ all_count }}</span>
    </a>
  </div>

  <!-- table -->
  <table class="content-table">
    <thead>
      <tr>
        <th data-col="account_name"    style="text-transform:uppercase;">Account Name</th>
        <th data-col="opening_balance" style="text-transform:uppercase;">Open Balance</th>
        <th data-col="as_of"           style="text-transform:uppercase;">Date</th>
        <th data-col="account_number"  style="text-transform:uppercase;">Account Number</th>
        <th data-col="account_type"  style="text-transform:uppercase;">Account Type</th>
        <th data-col="detail_type"     style="text-transform:uppercase;">Detail Type</th>
        <th data-col="description"     style="text-transform:uppercase;">Description</th>
        <th data-col="actions"         style="text-transform:uppercase;">Actions <i class='bx bxs-down-arrow'></i></th>
      </tr>
    </thead>

    <tbody>
  {% for section in level1_sections %}
    <!-- Level 1 heading row (one per category, not repeated per account) -->
    <tr class="section-row">
      <!-- use <th> so column hide/show JS (which targets td) doesn't break it -->
      <th colspan="8" style="background:#e9fbef; color:#0f5132; text-transform:uppercase; letter-spacing:.04em;">
        {{ section.label }}
      </th>
    </tr>

    {% if section.accounts %}
      {% for coa in section.accounts %}
        <tr class="{% if not coa.is_active %}inactive-row{% endif %}">
          <td>
            {% if coa.parent %}
              <span class="indent">{{ coa.account_name }}</span>
            {% else %}
              {{ coa.account_name }}
            {% endif %}
          </td>
          <td>{{ coa.opening_balance|intcomma }}</td>
          <td>{{ coa.as_of|date:"d/m/Y" }}</td>
          <td>{{ coa.account_number }}</td>
          <td>{{ coa.account_type }}</td>
          <td>{{ coa.detail_type }}</td>
          <td>{{ coa.description }}</td>
          <td class="action-cell">
            <div class="action-wrapper">
              <a href="#" class="edit-link {% if not coa.is_active %}disabled{% endif %}">Edit</a>
              <div class="dropdown">
                <i class='bx bx-chevron-down'></i>
                <div class="dropdown-menu">
                  {% if coa.is_active %}
                    <a href="{% url 'accounts:deactivate-account' coa.id %}">Make inactive</a>
                  {% else %}
                    <a href="{% url 'accounts:activate-account' coa.id %}">Activate</a>
                  {% endif %}
                </div>
              </div>
            </div>
          </td>
        </tr>
      {% endfor %}
    {% else %}
      <!-- structure visible even when empty -->
      <tr class="empty-row">
        <td colspan="8" style="font-style:italic; color:#6b7280; padding:10px 18px;">
          No accounts under this category yet.
        </td>
      </tr>
    {% endif %}
  {% endfor %}
</tbody>
 </table>

  <!-- Customize Modal -->
  <div id="customizeModal">
    <div class="modal-card">
      <h4>Customize Columns</h4>
      <div style="line-height: 1.9;">
        <label><input type="checkbox" class="col-toggle" data-col="account_name"    checked> Account Name</label><br>
        <label><input type="checkbox" class="col-toggle" data-col="opening_balance" checked> Opening Balance</label><br>
        <label><input type="checkbox" class="col-toggle" data-col="as_of"           checked> Date</label><br>
        <label><input type="checkbox" class="col-toggle" data-col="account_number"  checked> Account Number</label><br>
        <!-- account_type option removed -->
        <label><input type="checkbox" class="col-toggle" data-col="detail_type"     checked> Detail Type</label><br>
        <label><input type="checkbox" class="col-toggle" data-col="description"     checked> Description</label><br>
        <label><input type="checkbox" class="col-toggle" data-col="actions"         checked> Actions</label><br>
      </div>
      <div class="modal-actions">
        <button id="closeModal" class="btn btn-outline">Close</button>
        <button id="selectAll" class="btn btn-primary">Select all</button>
      </div>
    </div>
  </div>

  <!-- Safely inject prefs JSON -->
  {{ column_prefs|json_script:"col-prefs" }}

</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // ===== Elements
  const modal     = document.getElementById("customizeModal");
  const openBtn   = document.getElementById("customizeBtn");
  const closeBtn  = document.getElementById("closeModal");
  const selectAll = document.getElementById("selectAll");

  // ===== Load prefs safely
  let savedPrefs = {};
  try {
    savedPrefs = JSON.parse(document.getElementById("col-prefs").textContent) || {};
  } catch (e) {
    savedPrefs = {};
  }

  // ===== Helpers
  function toggleColumn(colName, show) {
    const header = document.querySelector(`th[data-col='${colName}']`);
    if (!header) return;
    const colIndex = header.cellIndex;
    document.querySelectorAll(`thead th:nth-child(${colIndex+1}), tbody td:nth-child(${colIndex+1})`)
      .forEach(cell => { cell.style.display = show ? "" : "none"; });
  }

  function applyAllPrefs() {
    document.querySelectorAll(".col-toggle").forEach(cb => {
      const col = cb.dataset.col;
      const value = (savedPrefs[col] !== undefined) ? savedPrefs[col] : true;
      cb.checked = !!value;
      toggleColumn(col, cb.checked);
    });
  }

  function savePrefs() {
    fetch("{% url 'accounts:save_column_prefs' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}",
      },
      body: JSON.stringify({ preferences: savedPrefs }),
    }).catch(()=>{});
  }

  // Init
  applyAllPrefs();

  openBtn.addEventListener("click", () => { modal.style.display = "flex"; });
  closeBtn.addEventListener("click", () => { modal.style.display = "none"; });
  modal.addEventListener("click", (e) => { if (e.target === modal) modal.style.display = "none"; });
  document.addEventListener("keydown", (e) => { if (e.key === "Escape") modal.style.display = "none"; });

  document.querySelectorAll(".col-toggle").forEach(cb => {
    cb.addEventListener("change", function() {
      const col = this.dataset.col;
      savedPrefs[col] = this.checked;
      toggleColumn(col, this.checked);
      savePrefs();
    });
  });

  selectAll.addEventListener("click", () => {
    document.querySelectorAll(".col-toggle").forEach(cb => {
      cb.checked = true;
      savedPrefs[cb.dataset.col] = true;
      toggleColumn(cb.dataset.col, true);
    });
    savePrefs();
  });
});
</script>

{% include 'includes/footer.html' %}
