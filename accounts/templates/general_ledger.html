{% load static %}
{% load humanize %}
{% include 'includes/navbar.html' %}
{% include 'includes/sidebar.html' %}

<style>
.gl-container {
  margin-left: 19.5%;
  width: 80%;
  margin-top: 6%;
  font-family: "Poppins", sans-serif;
}
.gl-header {
  display:flex;
  flex-direction: column;
  align-items:center;
  gap:6px;
  margin-bottom:16px;
}
.gl-title {
  color:#39B54B;
  font-weight:800;
  margin:0;
  text-align:center;
}
.gl-header-sub {
  margin:0;
  font-size:13px;
  color:#64748b;
  text-align:center;
}
.gl-actions {
  display:flex;
  gap:8px;
  justify-content:center;
}
.gl-actions button,
.gl-actions a {
  border:none;
  padding:6px 12px;
  border-radius:6px;
  font-size:13px;
  cursor:pointer;
  background:#e5f7ea;
  color:#14532d;
  text-decoration:none;
}
.gl-actions button:hover,
.gl-actions a:hover {
  background:#c9f0d5;
}
.gl-filters {
  margin-bottom:14px;
  padding:10px;
  border-radius:10px;
  background:#f3fff6;
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}
.gl-filters input,
.gl-filters select {
  border:1px solid #39B54B;
  border-radius:6px;
  padding:4px 8px;
  font-size:13px;
}
.gl-table {
  width:100%;
  border-collapse: collapse;
  margin-top:12px;
  background:white;
}
.gl-table thead th {
  background:#39B54B;
  color:white;
  padding:10px;
  font-size:12px;
  text-transform:uppercase;
  letter-spacing:.05em;
}
.gl-table td {
  border-bottom:1px solid #e5efe8;
  padding:8px;
  font-size:13px;
}
.gl-table td.num {
  text-align:right;
  white-space:nowrap;
}
.gl-row-link {
  color:inherit;
  text-decoration:none;
}
.gl-row-link:hover {
  text-decoration:underline;
}
.gl-totals {
  background:#003300;
  color:white;
  font-weight:bold;
}
.pagination {
  margin-top:12px;
  display:flex;
  gap:6px;
  align-items:center;
}
.pagination a,
.pagination span {
  padding:4px 8px;
  border-radius:4px;
  font-size:12px;
  text-decoration:none;
}
.pagination a {
  border:1px solid #39B54B;
  color:#14532d;
}
.pagination a.active,
.pagination span.current {
  background:#39B54B;
  color:white;
}
#colModal { display:none; }
@media print {
  .gl-actions,
  .gl-filters,
  .pagination,
  #sidebar {
    display:none !important;
  }
  .gl-container {
    width:100%;
    margin:0;
  }
}
.gl-back-row{ margin-bottom:4px; }
.gl-back-link{
  display:inline-block;
  color:#39B54B;
  font-weight:700;
  font-size:13px;
  text-decoration:none;
}
.gl-back-link:hover{ text-decoration:underline; }
.gl-filter-chip{
  margin-top:-4px;
  margin-bottom:8px;
  font-size:12px;
  color:#14532d;
}
.gl-filter-chip span{
  display:inline-block;
  background:#e8f5ec;
  border-radius:999px;
  padding:2px 8px;
  margin-right:4px;
}

/* ✅ Minimal additions for COA-like indentation + toggling */
.gl-indent{
  display:inline-block;
  margin-left:18px;
  padding-left:5px;
  border-left:3px dashed #39B54B;
  color:#065f46;
  font-style:italic;
}
.gl-acc-row td{
  background:#f3fff6;
  font-weight:800;
  color:#14532d;
}
.gl-toggle{
  display:inline-block;
  width:16px;
  cursor:pointer;
  user-select:none;
  margin-right:6px;
}
.gl-toggle.hidden{
  visibility:hidden;
}
</style>

<div class="gl-container">
  <div class="gl-back-row">
    <a href="{% url 'accounts:accounts' %}" class="gl-back-link" style="font-size: 20px;"> < Back to Accounts</a>
  </div>

  <div class="gl-header">
    <div>
      <h2 class="gl-title">General Ledger</h2>
      <p class="gl-header-sub">Ledger of transactions by account</p>
    </div>

    <div class="gl-actions">
      {# ✅ SAFE LINKS: do NOT output account_id=None/date_from=None/date_to=None #}
      <a href="?view=summary{% if account_id %}&account_id={{ account_id }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}{% if query %}&search={{ query }}{% endif %}">Summary View</a>

      <a href="?view=detail{% if account_id %}&account_id={{ account_id }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}{% if query %}&search={{ query }}{% endif %}">Detail View</a>

      <a href="#" id="openPrintView">Print / PDF</a>
      <a href="#" id="exportExcelBtn">Export Excel</a>
    </div>
  </div>

  <!-- FILTERS -->
  <form id="glFilterForm" method="get" class="gl-filters">
    <input type="hidden" name="view" value="{{ view_mode }}">

    {% if account_label or date_from or date_to %}
      <p class="gl-filter-chip">
        <span>{{ account_label|default:"All accounts" }}</span>
        {% if date_from or date_to %}
          <span>{{ date_from|default:"Start" }} – {{ date_to|default:"Today" }}</span>
        {% endif %}
      </p>
    {% endif %}

    <div style="position:relative;">
      <input
        type="text"
        id="accountSearch"
        list="accountOptions"
        placeholder="All accounts"
        autocomplete="off"
      />
      <datalist id="accountOptions">
        {% for acc in accounts %}
          <option value="{{ acc.account_name }}" data-id="{{ acc.id }}"></option>
        {% endfor %}
      </datalist>
      <input type="hidden" name="account_id" id="accountIdField" value="{{ account_id }}">
    </div>

    <input type="date" name="date_from" value="{{ date_from }}">
    <input type="date" name="date_to"   value="{{ date_to }}">
    <button class="button btn-sm" type="submit">Apply</button>
  </form>

  {% if mode == "summary" %}
    <!-- ✅ SUMMARY TABLE -->
    <table class="gl-table" id="glTable">
      <thead>
        <tr>
          <th>Account Name</th>
          <th>Account Number</th>
          <th>Account Type</th>
          <th class="num">Closing Balance</th>
        </tr>
      </thead>
      <tbody>
        {% for r in summary_rows %}
        <tr>
          <td>{{ r.account_name }}</td>
          <td>{{ r.account_number }}</td>
          <td>{{ r.account_type }}</td>
          <td class="num">{{ r.closing_balance|floatformat:2|intcomma }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="4" style="text-align:center; padding:10px;">No accounts found.</td></tr>
        {% endfor %}
      </tbody>

      <tr class="gl-totals">
        <td colspan="3">TOTAL</td>
        <td class="num">{{ total_balance|floatformat:2|intcomma }}</td>
      </tr>
    </table>

  {% else %}
    <!-- ✅ DETAIL TABLE -->
    <table class="gl-table" id="glTable">
      <thead>
        <tr>
          <th>Account Name</th>
          <th>Account Number</th>
          <th>Account Type</th>
          <th>Account Sub-Class</th>

          <th>Date</th>
          <th>Description</th>
          {% comment %} <th>Journal Reference</th> {% endcomment %}
          <th class="num">Debit</th>
          <th class="num">Credit</th>
          <th class="num">Running balance</th>
        </tr>
      </thead>

      <tbody>
        {% for r in detail_rows %}
          {% if r.kind == "account" %}
            <tr class="gl-acc-row"
                data-kind="account"
                data-path="{{ r.path }}"
                data-accid="{{ r.account_id }}">
              <td>
                {% if r.depth > 0 %}
                  <span class="gl-indent" style="margin-left:{{ r.depth|add:r.depth|add:r.depth|add:18 }}px;">
                    {% if r.has_children %}
                      <span class="gl-toggle" data-toggle="{{ r.path }}">▼</span>
                    {% else %}
                      <span class="gl-toggle hidden">▼</span>
                    {% endif %}
                    {{ r.account_name }}
                  </span>
                {% else %}
                  {% if r.has_children %}
                    <span class="gl-toggle" data-toggle="{{ r.path }}">▼</span>
                  {% else %}
                    <span class="gl-toggle hidden">▼</span>
                  {% endif %}
                  {{ r.account_name }}
                {% endif %}
              </td>
              <td>{{ r.account_number }}</td>
              <td>{{ r.account_type }}</td>
              <td>{{ r.detail_type }}</td>

              <td></td>
              <td></td>
              <td></td>
              <td class="num"></td>
              <td class="num"></td>
              <td class="num">{{ r.closing_balance|floatformat:2|intcomma }}</td>
            </tr>

          {% else %}
            <tr data-kind="tx" data-path="{{ r.path }}">
              <td>
                {% if r.depth > 0 %}
                  <span class="gl-indent" style="margin-left:{{ r.depth|add:r.depth|add:r.depth|add:18 }}px;">
                    {{ r.account_name }}
                  </span>
                {% else %}
                  {{ r.account_name }}
                {% endif %}
              </td>
              <td>{{ r.account_number }}</td>
              <td>{{ r.account_type }}</td>
              <td>{{ r.detail_type }}</td>

              <td>
                {% if r.url and r.url != "#" %}
                  <a href="{{ r.url }}" class="gl-row-link">{{ r.date|date:"d/m/Y" }}</a>
                {% else %}
                  {{ r.date|date:"d/m/Y" }}
                {% endif %}
              </td>
              <td>
                {% if r.url and r.url != "#" %}
                  <a href="{{ r.url }}" class="gl-row-link">{{ r.description }}</a>
                {% else %}
                  {{ r.description }}
                {% endif %}
              </td>
              {% comment %} <td>{{ r.reference }}</td> {% endcomment %}
              <td class="num">{{ r.debit|floatformat:2|intcomma }}</td>
              <td class="num">{{ r.credit|floatformat:2|intcomma }}</td>
              <td class="num">{{ r.balance|floatformat:2|intcomma }}</td>
            </tr>
          {% endif %}
        {% empty %}
          <tr><td colspan="10" style="text-align:center; padding:10px;">No transactions found.</td></tr>
        {% endfor %}
      </tbody>

      <tr class="gl-totals">
        <td colspan="7">TOTAL</td>
        <td class="num">{{ total_debit|floatformat:2|intcomma }}</td>
        <td class="num">{{ total_credit|floatformat:2|intcomma }}</td>
        <td class="num">{{ total_balance|floatformat:2|intcomma }}</td>
      </tr>
    </table>
  {% endif %}

  <!-- PAGINATION -->
  {% if page_obj and page_obj.paginator.num_pages > 1 %}
  <div class="pagination">
    {% if page_obj.has_previous %}
      <a href="?page={{ page_obj.previous_page_number }}&view={{ view_mode }}{% if account_id %}&account_id={{ account_id }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}{% if query %}&search={{ query }}{% endif %}">« Prev</a>
    {% endif %}
    <span class="current">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
    {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}&view={{ view_mode }}{% if account_id %}&account_id={{ account_id }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}{% if query %}&search={{ query }}{% endif %}">Next »</a>
    {% endif %}
  </div>
  {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const exportBtn = document.getElementById("exportExcelBtn");
  const filterForm = document.getElementById("glFilterForm");

  exportBtn.addEventListener("click", function(e) {
    e.preventDefault();
    const params = new URLSearchParams(new FormData(filterForm));

    // ✅ prevent exporting with account_id=None / date_from=None / date_to=None
    ["account_id", "date_from", "date_to"].forEach(k => {
      const v = params.get(k);
      if (v === "None" || v === "null" || v === "") params.delete(k);
    });

    params.set("export", "excel");
    window.location = window.location.pathname + "?" + params.toString();
  });
});

document.addEventListener("DOMContentLoaded", function() {
  const printBtn = document.getElementById("openPrintView");
  const filterForm = document.getElementById("glFilterForm");

  printBtn.addEventListener("click", function(e) {
    e.preventDefault();
    const params = new URLSearchParams(new FormData(filterForm));

    // ✅ prevent printing with account_id=None / date_from=None / date_to=None
    ["account_id", "date_from", "date_to"].forEach(k => {
      const v = params.get(k);
      if (v === "None" || v === "null" || v === "") params.delete(k);
    });

    const url = "{% url 'accounts:general-ledger-print' %}" + "?" + params.toString();
    window.open(url, "_blank");
  });
});

// searchable account field wiring (unchanged)
document.addEventListener("DOMContentLoaded", function () {
  const accountInput  = document.getElementById("accountSearch");
  const accountHidden = document.getElementById("accountIdField");
  const dataList      = document.getElementById("accountOptions");

  if (!accountInput || !accountHidden || !dataList) return;

  const options = Array.from(dataList.options);

  function syncFromHidden() {
    const currentId = accountHidden.value;
    if (!currentId || currentId === "None" || currentId === "null") {
      accountHidden.value = "";
      accountInput.value = "";
      return;
    }
    const match = options.find(opt => opt.dataset.id === currentId);
    if (match) {
      accountInput.value = match.value;
    }
  }
  syncFromHidden();

  accountInput.addEventListener("change", function () {
    const typed = this.value.toLowerCase().trim();
    const match = options.find(opt => opt.value.toLowerCase().trim() === typed);
    if (match) {
      accountHidden.value = match.dataset.id;
    } else {
      accountHidden.value = "";
    }
  });

  accountInput.addEventListener("input", function () {
    if (!this.value) {
      accountHidden.value = "";
    }
  });
});

// ✅ Toggle collapse/expand (unchanged)
document.addEventListener("DOMContentLoaded", function () {
  function isDescendantPath(childPath, parentPath) {
    return childPath !== parentPath && childPath.startsWith(parentPath + "/");
  }

  document.querySelectorAll(".gl-toggle").forEach(btn => {
    const path = btn.getAttribute("data-toggle");
    if (!path) return;

    btn.addEventListener("click", function () {
      const isOpen = (btn.textContent || "").trim() === "▼";
      btn.textContent = isOpen ? "▶" : "▼";

      document.querySelectorAll("tr[data-path]").forEach(row => {
        const rowPath = row.getAttribute("data-path");
        if (!rowPath) return;

        if (isDescendantPath(rowPath, path)) {
          row.style.display = isOpen ? "none" : "";
        }
      });
    });
  });
});
</script>

{% include 'includes/footer.html' %}
