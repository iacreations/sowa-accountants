{% load humanize static %}
{% load static %}
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="icon" type="image/x-icon" href="{% static 'sowaf/images/favicon.ico' %}">
  <link rel="stylesheet" href="{% static 'sowaf/styles/bootsrap.min.css' %}" />
  <title>Profit & Loss</title>
  <style>
    :root{
      --brand:#39B54B; --ink:#0f5132;
      --line:#e7e7e7; --muted:#6b7280; --bg:#f4f6f8;
      --head:#f7fff8; --card:#ffffff; --warn:#fff7e6;
    }
    body{background:var(--bg);font-family:Poppins,system-ui,Segoe UI,Arial;margin:24px}
    .wrap{max-width:1100px;margin:auto}
    h1{color:var(--brand);margin:0 0 8px}
    .sub{color:var(--muted);margin-bottom:14px}

    .filters{
      display:flex; gap:10px; align-items:center; margin:12px 0 18px;
      flex-wrap:wrap;
    }
    .filters input[type="date"]{border:1px solid #d1d5db;border-radius:8px;padding:8px 10px;background:#fff}
    .btn{border:0;border-radius:8px;padding:8px 12px;font-weight:800;cursor:pointer}
    .btn.run{background:var(--brand);color:#fff}
    .btn.clear{background:#eaf7ee;color:#0f5132;border:1px solid #cfe9d6}

    .grid{
      display:grid; grid-template-columns: 1fr 320px; gap:16px;
    }
    @media (max-width: 900px){ .grid{ grid-template-columns:1fr; } }

    .card{
      background:var(--card); border:1px solid var(--line); border-radius:14px;
      box-shadow:0 8px 22px rgba(0,0,0,.06);
    }

    .section{margin-bottom:14px}
    .section h3{
      margin:0; padding:12px 14px; border-bottom:1px solid var(--line);
      background:linear-gradient(0deg,#e6f7ea,#f5fff8); color:var(--ink);
    }
    table{width:100%; border-collapse:separate; border-spacing:0}
    td{padding:10px 12px; border-bottom:1px solid #f1f1f1}
    td.num{text-align:right; white-space:nowrap}
    tr:last-child td{border-bottom:0}

    .tot-row td{font-weight:800; background:#f8fff9}
    .summary{padding:14px}
    .summary .row{display:flex; justify-content:space-between; gap:10px; margin:8px 0}
    .summary .label{color:#64748b}
    .summary .big{font-size:20px; font-weight:900; color:#0f5132}
    .neg{color:#b91c1c}

    .gl-link{ color:inherit; text-decoration:none; }
    .gl-link:hover{ text-decoration:underline; }
  </style>
</head>
<body>
  <a href="{% url accounts:reports' %}" style="color: #39B54B; font-weight: 900; text-decoration: none; margin-left: 3%;"> &lt; Back to Reports </a>

  <div class="wrap">

    <div class="text-center mb-3">
      <div class="sub">{{ company_name }}</div>
      <h1>Statement of Profit or Loss</h1>
      <div class="sub">
        For the period
        {% if dfrom %}{{ dfrom|date:"d/m/Y" }}{% else %}None{% endif %}
        – {% if dto %}{{ dto|date:"d/m/Y" }}{% else %}None{% endif %}
      </div>
      <div class="sub">
        Reporting Currency: {{ reporting_currency }}
      </div>
    </div>

    <div class="filters d-flex">
      <span class="sub">
        Period:
        {% if dfrom %}{{ dfrom|date:"M j, Y" }}{% else %}None{% endif %}
        – {% if dto %}{{ dto|date:"M j, Y" }}{% else %}None{% endif %}
      </span>
      <br><br>

      <form method="get" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;" class="ms-auto">
        From <input type="date" name="from" value="{{ dfrom|date:'Y-m-d' }}">
        To <input type="date" name="to" value="{{ dto|date:'Y-m-d' }}">

        <select name="basis" style="border:1px solid #d1d5db;border-radius:8px;padding:8px 10px;background:#fff">
          <option value="accrual" {% if basis == "accrual" %}selected{% endif %}>Accrual</option>
          <option value="cash" {% if basis == "cash" %}selected{% endif %}>Cash</option>
        </select>

        <button class="btn run" type="submit">Run</button>
        <a class="btn clear" href="{% url 'accounts:report-pnl' %}">Clear</a>
      </form>
    </div>

    <div class="grid">
      <div class="card">

        <div class="section">
          <h3>Operating</h3>
          <table>
            <tbody>

              <tr>
                <td><strong>Revenue</strong></td>
                <td class="num"></td>
              </tr>
              {% for row in buckets.income %}
              <tr>
                <td>
                  <a class="gl-link"
                     href="{% url 'accounts:general-ledger' %}?account_id={{ row.account_id }}&basis={{ basis }}{% if dfrom %}&date_from={{ dfrom|date:'Y-m-d' }}{% endif %}{% if dto %}&date_to={{ dto|date:'Y-m-d' }}{% endif %}">
                    {{ row.account }}
                  </a>
                </td>
                <td class="num">
                  <a class="gl-link"
                     href="{% url 'accounts:general-ledger' %}?account_id={{ row.account_id }}&basis={{ basis }}{% if dfrom %}&date_from={{ dfrom|date:'Y-m-d' }}{% endif %}{% if dto %}&date_to={{ dto|date:'Y-m-d' }}{% endif %}">
                    {{ row.amount|floatformat:2|intcomma }}
                  </a>
                </td>
              </tr>
              {% empty %}
                <tr><td colspan="2" style="color:#6b7280;padding:12px">No revenue in this period.</td></tr>
              {% endfor %}
              <tr class="tot-row">
                <td>Total revenue</td>
                <td class="num">{{ totals.income|floatformat:2|intcomma }}</td>
              </tr>

              <tr>
                <td style="padding-top:18px;"><strong>Cost of goods sold</strong></td>
                <td class="num" style="padding-top:18px;"></td>
              </tr>
              {% for row in buckets.cogs %}
              <tr>
                <td>
                  <a class="gl-link"
                     href="{% url 'accounts:general-ledger' %}?account_id={{ row.account_id }}&basis={{ basis }}{% if dfrom %}&date_from={{ dfrom|date:'Y-m-d' }}{% endif %}{% if dto %}&date_to={{ dto|date:'Y-m-d' }}{% endif %}">
                    {{ row.account }}
                  </a>
                </td>
                <td class="num">
                  <a class="gl-link"
                     href="{% url 'accounts:general-ledger' %}?account_id={{ row.account_id }}&basis={{ basis }}{% if dfrom %}&date_from={{ dfrom|date:'Y-m-d' }}{% endif %}{% if dto %}&date_to={{ dto|date:'Y-m-d' }}{% endif %}">
                    {{ row.amount|floatformat:2|intcomma }}
                  </a>
                </td>
              </tr>
              {% empty %}
                <tr><td colspan="2" style="color:#6b7280;padding:12px">No COGS in this period.</td></tr>
              {% endfor %}
              <tr class="tot-row">
                <td>Total COGS</td>
                <td class="num">{{ totals.cogs|floatformat:2|intcomma }}</td>
              </tr>

              <tr class="tot-row">
                <td><strong>Gross profit</strong></td>
                <td class="num"><strong>{{ gross_profit|floatformat:2|intcomma }}</strong></td>
              </tr>

              <tr>
                <td style="padding-top:18px;"><strong>Operating expenses</strong></td>
                <td class="num" style="padding-top:18px;"></td>
              </tr>
              {% for row in buckets.expense %}
              <tr>
                <td>
                  <a class="gl-link"
                     href="{% url 'accounts:general-ledger' %}?account_id={{ row.account_id }}&basis={{ basis }}{% if dfrom %}&date_from={{ dfrom|date:'Y-m-d' }}{% endif %}{% if dto %}&date_to={{ dto|date:'Y-m-d' }}{% endif %}">
                    {{ row.account }}
                  </a>
                </td>
                <td class="num">
                  <a class="gl-link"
                     href="{% url 'accounts:general-ledger' %}?account_id={{ row.account_id }}&basis={{ basis }}{% if dfrom %}&date_from={{ dfrom|date:'Y-m-d' }}{% endif %}{% if dto %}&date_to={{ dto|date:'Y-m-d' }}{% endif %}">
                    {{ row.amount|floatformat:2|intcomma }}
                  </a>
                </td>
              </tr>
              {% empty %}
                <tr><td colspan="2" style="color:#6b7280;padding:12px">No operating expenses in this period.</td></tr>
              {% endfor %}
              <tr class="tot-row">
                <td>Total operating expenses</td>
                <td class="num">{{ totals.expense|floatformat:2|intcomma }}</td>
              </tr>

              <tr class="tot-row">
                <td><strong>Operating profit</strong></td>
                <td class="num"><strong>{{ operating_profit|floatformat:2|intcomma }}</strong></td>
              </tr>

            </tbody>
          </table>
        </div>

        <div class="section">
          <h3>Investing</h3>
          <table>
            <tbody>
              <tr>
                <td style="color:#6b7280;padding:12px">
                  No investing income/expense classified yet.
                </td>
                <td class="num"></td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="section" style="margin-bottom:0">
          <h3>Financing</h3>
          <table>
            <tbody>
              <tr>
                <td style="color:#6b7280;padding:12px">
                  No financing income/expense classified yet.
                </td>
                <td class="num"></td>
              </tr>
            </tbody>
          </table>
        </div>

      </div>

      <div class="card summary">
        <div class="row">
          <span class="label">Gross profit</span>
          <span class="value">{{ gross_profit|floatformat:2|intcomma }}</span>
        </div>

        <div class="row">
          <span class="label">Operating profit</span>
          <span class="value">{{ operating_profit|floatformat:2|intcomma }}</span>
        </div>

        <hr style="border:none;border-top:1px solid #eee;margin:8px 0">

        <div class="row">
          <span class="label">Profit before financing &amp; income tax</span>
          <span class="value">
            {{ profit_before_financing_tax|floatformat:2|intcomma }}
          </span>
        </div>

        <div class="row">
          <span class="label">Profit before income tax</span>
          <span class="value">
            {{ profit_before_income_tax|floatformat:2|intcomma }}
          </span>
        </div>

        <hr style="border:none;border-top:1px solid #eee;margin:8px 0">

        <div class="row" style="margin-top:10px">
          <span class="label big">Net Profit</span>
          <span class="big {% if net_profit < 0 %}neg{% endif %}">
            {{ net_profit|floatformat:2|intcomma }}
          </span>
        </div>
      </div>

    </div>
  </div>
</body>
</html>
