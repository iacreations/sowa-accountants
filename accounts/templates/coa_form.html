{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% if account %}Edit Account{% else %}Chart of Accounts Form{% endif %}</title>
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
  <link rel="icon" type="image/x-icon" href="{% static 'sowaf/images/favicon.ico' %}">
  <link rel="stylesheet" href="{% static 'sowaf/styles/style.css' %}" />
  <link rel="stylesheet" href="{% static 'sowaf/styles/bootsrap.min.css' %}" />
  <style>
    * {
      box-sizing: border-box;
      font-family: "Poppins", sans-serif;
      margin: 0;
      padding: 0;
      font-size: 14px;
    }
    body {
      background: #f4f6f8;
      padding: 30px;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: #fff;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h2.title {
      text-align: center;
      color: #39B54B;
      margin-bottom: 25px;
    }
    .section-wrapper {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 25px;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
    }
    label {
      font-weight: 500;
      margin-bottom: 5px;
    }
    input, select, textarea {
      padding: 8px 10px;
      border: 1px solid green;
      border-radius: 6px;
    }
    textarea { border: 1px solid green; }
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }
    .footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 30px;
      border-top: 1px solid #e0e0e0;
      padding-top: 20px;
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    }
    .btn-cancel { background: #f5f5f5; }
    .btn-green { background: #39B54B; color: #fff; }
    .dropdown {
      position: relative;
      display: inline-block;
    }
    .dropdown-menu {
      display: none;
      position: absolute;
      right: 0;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 6px;
      z-index: 10;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .dropdown:hover .dropdown-menu { display: block; }
    .dropdown-menu button {
      width: 100%;
      padding: 10px 16px;
      background: none;
      border: none;
      text-align: left;
      cursor: pointer;
    }
  </style>
</head>
<body>
<a href="{% url 'accounts:accounts' %}"
   class="text-decoration-none"
   id="btn"
   style="color: #39B54B;font-size: 23px;">
  Back to Chart of accounts
</a>

<div class="container">
  <form method="post"
        action="{% if account %}{% url 'accounts:edit-account' account.id %}{% else %}{% url 'accounts:add-account' %}{% endif %}">
    {% csrf_token %}
    <h2 class="title">
      {% if account %}Edit Account{% else %}Chart of Accounts{% endif %}
    </h2>

    <div class="section-wrapper">
      <div class="form-grid">
        <div class="form-group">
          <label>Account Name *</label>
          <input type="text"
                 name="account_name"
                 id="account"
                 value="{{ account.account_name|default_if_none:'' }}"
                 required>
        </div>

        <div class="form-group">
          <label>Account Number</label>
          <input type="text"
                 name="account_number"
                 id="account_number"
                 value="{{ account.account_number|default_if_none:'' }}">
        </div>

        <!-- ACCOUNT TYPE (codes) -->
        <div class="form-group">
          <label>Account Type *</label>
          <select name="account_type" id="account_type" required>
            <option value="">Select account type</option>
            <option value="CURRENT_ASSET"      {% if account and account.account_type == "CURRENT_ASSET" %}selected{% endif %}>Current Assets</option>
            <option value="NON_CURRENT_ASSET"  {% if account and account.account_type == "NON_CURRENT_ASSET" %}selected{% endif %}>Non Current Assets</option>

            <option value="CURRENT_LIABILITY"     {% if account and account.account_type == "CURRENT_LIABILITY" %}selected{% endif %}>Current Liabilities</option>
            <option value="NON_CURRENT_LIABILITY" {% if account and account.account_type == "NON_CURRENT_LIABILITY" %}selected{% endif %}>Non Current Liabilities</option>

            <option value="OWNER_EQUITY" {% if account and account.account_type == "OWNER_EQUITY" %}selected{% endif %}>Owner's Equity</option>

            <option value="OPERATING_INCOME"  {% if account and account.account_type == "OPERATING_INCOME" %}selected{% endif %}>Operating Income</option>
            <option value="INVESTING_INCOME"  {% if account and account.account_type == "INVESTING_INCOME" %}selected{% endif %}>Investing Income</option>

            <option value="OPERATING_EXPENSE"   {% if account and account.account_type == "OPERATING_EXPENSE" %}selected{% endif %}>Operating Expense</option>
            <option value="INVESTING_EXPENSE"   {% if account and account.account_type == "INVESTING_EXPENSE" %}selected{% endif %}>Investing Expense</option>
            <option value="FINANCING_EXPENSE"   {% if account and account.account_type == "FINANCING_EXPENSE" %}selected{% endif %}>Financing Expense</option>
            <option value="INCOME_TAX_EXPENSE"  {% if account and account.account_type == "INCOME_TAX_EXPENSE" %}selected{% endif %}>Income taxes</option>
          </select>
        </div>

        <!-- DETAIL TYPE -->
        <div class="form-group">
          <label>Account Sub-Class</label>
          <select name="detail_type"
                  id="detail_type"
                  required
                  data-current="{{ account.detail_type|default_if_none:'' }}">
            <!-- options are injected by JS based on account_type -->
            <option value=""></option>
          </select>
        </div>

        <div class="form-group">
          <label>Tax Category</label>
          <select name="tax_category">
            <option value="" {% if not account or not account.tax_category %}selected{% endif %}>None</option>
            <option value="Capital deductions" {% if account and account.tax_category == "Capital deductions" %}selected{% endif %}>Capital deductions</option>
            <option value="Allowable deduction" {% if account and account.tax_category == "Allowable deduction" %}selected{% endif %}>Allowable deduction</option>
            <option value="Non Allowable deduction" {% if account and account.tax_category == "Non Allowable deduction" %}selected{% endif %}>Non Allowable deduction</option>
          </select>
        </div>

        <div class="form-group my-5">
          <label for="subAccountCheckbox">
            Make this a sub-account.
            <input type="checkbox"
                   id="subAccountCheckbox"
                   name="is_subaccount"
                   {% if account and account.is_subaccount %}checked{% endif %}>
          </label>
        </div>

        <div id="parent_account_field"
             style="display: {% if account and account.is_subaccount %}block{% else %}none{% endif %};">
          <label for="parent">Parent Account</label>
          <div></div>
          <select name="parent" id="parent">
            <option value="">choose parent account</option>
            {% for parent in parents %}
              <option value="{{ parent.id }}"
                      {% if account and account.parent_id == parent.id %}selected{% endif %}>
                {{ parent.account_name }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="form-grid my-5">
          <div class="form-group">
            <label>Opening Balance</label>
            <input type="number"
                   step="0.01"
                   name="opening_balance"
                   value="{{ account.opening_balance|default_if_none:'' }}">
          </div>
        </div>

        <div class="form-group">
          <label>As of</label>
          <input type="date"
                 name="as_of"
                 value="{% if account and account.as_of %}{{ account.as_of|date:'Y-m-d' }}{% endif %}">
        </div>
      </div>
    </div>

    <!-- More Info Section -->
    <div class="section-wrapper" id="more_info_section">
      <h3 style="margin-bottom: 15px; color: #39B54B;">More Info on Opening Balances</h3>
      <div class="form-group">
        <label>Description</label>
        <textarea name="description" rows="3">{{ account.description|default_if_none:'' }}</textarea>
      </div>
    </div>

    <!-- Footer Buttons -->
    <div class="footer">
      <a href="{% url 'accounts:accounts' %}" class="text-decoration-none button btn-sm" id="btn">Cancel</a>

      <div class="dropdown">
        <button type="button" class="btn button btn-green">Save ▼</button>
        <div class="dropdown-menu">
          <button type="submit" name="save_action" value="save">Save</button>
          <button type="submit" name="save_action" value="save&new">Save & New</button>
          <button type="submit" name="save_action" value="save&close">Save & Close</button>
        </div>
      </div>
    </div>
  </form>
</div>

<script src="{% static 'sowaf/styles/script.js' %}"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // ===== Sub-account toggle =====
  const checkbox    = document.getElementById("subAccountCheckbox");
  const parentField = document.getElementById("parent_account_field");

  checkbox.addEventListener("change", function () {
    parentField.style.display = this.checked ? "block" : "none";
  });

  // ===== Account Type / Detail Type logic =====
  const accountTypeDropdown = document.getElementById("account_type");
  const detailTypeDropdown  = document.getElementById("detail_type");

  // Mapping of Account Type CODE → Detail Types (labels)
  const detailOptions = {
    "CURRENT_ASSET": [
      "Assets held for sale","Inventory","Prepayments",
      "Accounts Receivables (A/R)","Other receivables",
      "Cash and Cash equivalents","Other current assets"
    ],
    "NON_CURRENT_ASSET": [
      "Property","Plant","Equipment"," Furniture & Fittings","Motor Vehicle",
      "Investment property","Intangible Assets","Right of Use Assets",
      "Deffered tax Assets","Other Long term Assets","IT Equipment","Office Equipment ","Bearer Plants","Biological Assets","Deffered Tax Assets"
    ],
    "CURRENT_LIABILITY": [
      "Accounts Payable (A/P)","Other Payables","Provisions",
      "Short term borrowings","Current tax liabilities",
      "Accrued expenses","Other Current liabilities"
    ],
    "NON_CURRENT_LIABILITY": [
      "Long term Borrowings","Pension and other employee obligations",
      "Long term Lease Liabilities","Deffered tax liabilities",
      "Other Non Curent Liabilities"
    ],
    "OWNER_EQUITY": [
      "Share Capital","Share premium","Retained earnings",
      "Non controlling interest","Other Equity components"
    ],
    "OPERATING_INCOME":[
      "Revenue", "Other operating income"
    ],
    "OPERATING_EXPENSE":[
      "Cost of Goods sold","Cost of Sales","Selling and distribution",
      "Administration expenses","Research and development",
      "Other operating expenses"
    ],
    "INVESTING_INCOME":[
      "Share of profits from associates","Rental Income","Dividends",
      "Interest income","Depreciation","Impairment", "Losses",
      "Impairment Reversal","Loss on Disposal of Investments",
      "Other Investing Income"
    ],
    "INVESTING_EXPENSE":[
      "Gain on Disposal of Investments","Fairvalue Gains",
      "Fairvalue Losses","Other Investing Expenses"
    ],
    "FINANCING_EXPENSE":[
      "Interest expense","Other Financing Costs"
    ],
    "INCOME_TAX_EXPENSE":[
      "Income Tax Expense","Other Tax Expenses"
    ],
  };

  function updateDetailTypes(accountTypeCode) {
    const current = detailTypeDropdown.dataset.current || "";
    detailTypeDropdown.innerHTML = "<option value=''></option>";

    if (detailOptions[accountTypeCode]) {
      detailOptions[accountTypeCode].forEach(function (detail) {
        const option = document.createElement("option");
        option.value = detail;
        option.textContent = detail;
        detailTypeDropdown.appendChild(option);
      });
    }

    if (current) {
      detailTypeDropdown.value = current;
    }
  }

  // ===== Opening Balance / As Of / More Info visibility =====
  const openingBalanceField = document.querySelector("input[name='opening_balance']").closest(".form-group");
  const asOfField           = document.querySelector("input[name='as_of']").closest(".form-group");
  const moreInfoSection     = document.getElementById("more_info_section");

  const balanceSheetTypes = [
    "CURRENT_ASSET",
    "NON_CURRENT_ASSET",
    "CURRENT_LIABILITY",
    "NON_CURRENT_LIABILITY",
    "OWNER_EQUITY"
  ];

  function toggleBalanceFields() {
    const selectedCode = accountTypeDropdown.value;
    if (balanceSheetTypes.includes(selectedCode)) {
      openingBalanceField.style.display = "block";
      asOfField.style.display = "block";
      moreInfoSection.style.display = "block";
    } else {
      openingBalanceField.style.display = "none";
      asOfField.style.display = "none";
      moreInfoSection.style.display = "none";
    }
  }

  accountTypeDropdown.addEventListener("change", function () {
    updateDetailTypes(this.value);
    toggleBalanceFields();
  });

  // Initial run (add or edit)
  if (accountTypeDropdown.value) {
    updateDetailTypes(accountTypeDropdown.value);
  }
  toggleBalanceFields();
});
</script>
</body>
</html>
