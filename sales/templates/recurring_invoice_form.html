{% load static %}
{% load humanize %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Create Recurring Invoice</title>
  <link rel="icon" type="image/x-icon" href="{% static 'sowaf/images/favicon.ico' %}">
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'sowaf/styles/style.css' %}" />
  <link rel="stylesheet" href="{% static 'sowaf/styles/bootsrap.min.css' %}" />

  <style>
    body{
      background:#f4f6f8;
      font-family:"Poppins", sans-serif;
      padding:0;
      margin:0;
    }

    /* container look stays like your invoice */
    .container{
      background:#fff;
      padding:25px;
      border-radius:10px;
      max-width:1100px;
      box-shadow:0 2px 8px rgba(0,0,0,0.08);
    }

    h2{ color:#39B54B; text-align:center; margin-bottom:30px; }
    .section-title{ font-size:18px; font-weight:600; margin:25px 0 10px; color:#39B54B; }

    .form-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(240px, 1fr));
      gap:20px;
      margin-bottom:20px;
    }

    .form-group{ display:flex; flex-direction:column; }
    .form-group label{ font-weight:500; margin-bottom:6px; }
    .form-group input, .form-group select, .form-group textarea{
      padding:8px;
      border:1px solid #ccc;
      border-radius:6px;
    }

    table{ width:100%; border-collapse:collapse; margin-bottom:10px; }
    th, td{ padding:8px; border:1px solid #ddd; text-align:left; }
    th{ background:#f9f9f9; }

    .table-scroll-x{
      width:100%;
      overflow-x:auto;
      overflow-y:hidden;
      -webkit-overflow-scrolling:touch;
      border-radius:8px;
    }

    .invoice-table{
      width:100%;
      min-width:1700px;
      table-layout:auto;
    }

    .invoice-table th, .invoice-table td{
      padding:8px 10px;
      vertical-align:middle;
    }

    .invoice-table th{ white-space:nowrap; font-size:14px; }

    .invoice-table input, .invoice-table select{
      height:34px;
      min-height:34px;
      padding:6px 8px;
      box-sizing:border-box;
      width:100%;
    }

    td input.rate{ width:100% !important; }

    /* FIX: reduce the big top margin */
    #container{
      width:80%;
      margin-left:20%;
      margin-top:5%;   /* was 12% */
      margin-right:0;
    }

    /* FIX: reduce mobile top margin too */
    @media (max-width: 1024px){
      #container{
        width:95%;
        margin-left:0;
        margin-top:5%;  /* was 18% */
        margin-right:auto;
      }
    }

    /* keep laptop layout but with smaller top margin */
    @media only screen and (min-width: 1024px) and (max-width: 1600px) {
      #container{
        width:80%;
        margin-top: 5%;  /* was 12% */
        margin-left:19.5%;
      }
    }
  </style>
</head>

<body>

  <!-- NAVBAR INCLUDED -->
  {% include 'includes/navbar.html' %}

  <!-- SIDEBAR INCLUDED -->
  {% include 'includes/sidebar.html' %}

  <div class="container" id="container">
    <h2 style="color:#39B54B; text-align:center; margin-bottom:20px;">Recurring Invoice</h2>

    <form method="post" action="{% url 'sales:recurring-invoice-new' %}" enctype="multipart/form-data">
      {% csrf_token %}

      <!-- Recurring Schedule (ONE COLUMN STACK) -->
      <div class="section-title" style="color:#39B54B; font-weight:600; margin:16px 0 8px;">Create Recurring Schedule</div>

      <div style="display:flex; flex-direction:column; gap:12px; max-width:420px;">
        <div class="form-group">
          <label>Frequency</label>
          <select name="frequency" class="form-control">
            <option value="daily">Daily</option>
            <option value="weekly">Weekly</option>
            <option value="monthly" selected>Monthly</option>
            <option value="yearly">Yearly</option>
          </select>
        </div>

        <div class="form-group">
          <label>Interval (Every N)</label>
          <input type="number" name="interval" value="1" min="1">
        </div>

        <div class="form-group">
          <label>Start Date</label>
          <input type="date" name="start_date">
        </div>

        <div class="form-group">
          <label>End Date (Optional)</label>
          <input type="date" name="end_date">
        </div>

        <div class="form-group">
          <label>Max Occurrences (Optional)</label>
          <input type="number" name="max_occurrences" min="1" placeholder="e.g. 12">
        </div>
      </div>

      <!-- Customer / Header -->
      <div class="section-title" style="color:#39B54B; font-weight:600; margin:16px 0 8px;">Customer Details</div>

      <div class="form-grid" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:16px;">
        <div class="form-group">
          <label>Customer</label>
          <select class="form-control" name="customer" id="customer-select" required>
            <option value=""> Select Customer </option>
            {% for customer in customers %}
              <option value="{{ customer.id }}">{{ customer.customer_name }}</option>
            {% endfor %}
            <option value="add_new">➕ Add New</option>
          </select>
        </div>

        <div class="form-group">
          <label>Email</label>
          <input name="email" type="email">
        </div>

        <div class="form-group">
          <label>Terms</label>
          <select name="terms" id="terms" class="form-control">
            <option value="">Select terms</option>
            <option value="due_on_receipt" data-days="0">Due on receipt</option>
            <option value="one_day" data-days="1">One day</option>
            <option value="two_days" data-days="2">Two days</option>
            <option value="net_7" data-days="7">Net 7</option>
            <option value="net_15" data-days="15">Net 15</option>
            <option value="net_30" data-days="30">Net 30</option>
            <option value="net_60" data-days="60">Net 60</option>
            <option value="credit_limit" data-days="27">Credit Limit (27)</option>
            <option value="credit_allowance" data-days="29">Credit Allowance (29)</option>
          </select>
        </div>

        <div class="form-group">
          <label>Billing Address</label>
          <input name="billing_address">
        </div>

        <div class="form-group">
          <label>Shipping Address</label>
          <input name="shipping_address">
        </div>

        <div class="form-group">
          <label>Sales Rep</label>
          <input type="text" name="sales_rep">
        </div>

        <div class="form-group">
          <label>Class</label>
          <select name="class_field" id="classSelect" class="form-control" required>
            <option value="">Select Class</option>
            {% for class in classes %}
              <option value="{{ class.id }}">{{ class.class_name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="form-group">
          <label>Tags</label>
          <input type="text" name="tags">
        </div>

        <div class="form-group">
          <label>PO Number</label>
          <input type="text" name="po_number">
        </div>
      </div>

      <!-- Line Items -->
      <h5 class="section-title" style="color:#39B54B; font-weight:600; margin:16px 0 8px;">Item Details</h5>

      <div class="table-scroll-x">
        <table class="invoice-table" style="border-collapse:collapse;">
          <thead>
            <tr style="background:#f9f9f9;">
              <th>Product/Service</th>
              <th>Description</th>
              <th style="text-align:right;">Qty</th>
              <th style="text-align:right;">Rate</th>
              <th style="text-align:right;">Amount</th>
              <th style="text-align:right;">VAT (18%)</th>
              <th style="text-align:right;">Discount (%)</th>
              <th style="text-align:right;">Discount Amount</th>
              <th>Action</th>
            </tr>
          </thead>

          <tbody id="invoice-items-table">
            <tr>
              <td>
                <select class="form-control product-select" name="product[]" onchange="handleProductSelect(this)">
                  <option value="">-- Select Product --</option>
                  {% for product in products %}
                    <option value="{{ product.id }}"
                            data-description="{{ product.sales_description }}"
                            data-rate="{{ product.sales_price }}"
                            data-taxable="{{ product.taxable|yesno:'true,false' }}">
                      {{ product.name }}
                    </option>
                  {% endfor %}
                  <option value="add_new">➕ Add New</option>
                </select>
              </td>
              <td><input type="text" name="description[]" class="form-control description" readonly></td>
              <td><input type="number" name="qty[]" class="form-control qty" value="1" min="1" onchange="calculateRow(this)"></td>
              <td><input type="number" name="unit_price[]" class="form-control rate" onchange="calculateRow(this)"></td>
              <td><input type="number" name="amount[]" class="form-control amount" readonly></td>
              <td><input type="number" name="vat[]" class="form-control vat" readonly></td>
              <td><input type="number" name="discount_num[]" class="form-control discount" value="0" min="0" max="100" onchange="calculateRow(this)"></td>
              <td><input type="number" name="discount_amount[]" class="form-control discount-amt" readonly></td>
              <td class="text-center">
                <button type="button" class="btn btn-sm" onclick="deleteRow(this)">
                  <i class='bx bxs-trash' style="color: green;"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="mt-2 d-flex" style="display:flex; gap:8px;">
        <button type="button" class="btn btn-success btn-sm" onclick="addRow()">+ Add Row</button>
        <button type="button" class="btn btn-success btn-sm" style="margin-left:auto;" onclick="clearTable()">Clear All</button>
      </div>

      <!-- Notes / Summary -->
      <div class="summary-notes" style="display:flex; justify-content:space-between; flex-wrap:wrap; margin-top:20px;">
        <div class="notes-section" style="flex:1 1 50%; padding-right:20px;">
          <div class="form-group">
            <label>Memo</label>
            <textarea rows="3" name="memo"></textarea>
          </div>
          <div class="form-group">
            <label>Custom Invoice Notes</label>
            <textarea rows="3" placeholder="Terms or notes to customer..." name="customs_notes"></textarea>
          </div>
        </div>

        <div class="summary-section" style="flex:1 1 40%; display:flex; flex-direction:column; align-items:flex-end;">
          <!-- Totals (same behavior as invoice form) -->
          <div class="form-group" style="width:100%; max-width:300px; margin-bottom:10px;">
            <label>Subtotal</label>
            <input type="number" id="subtotal" name="subtotal" value="0" readonly />
          </div>

          <div class="form-group" style="width:100%; max-width:300px; margin-bottom:10px;">
            <label>Total Discount</label>
            <input type="number" id="discountAmount" name="total_discount" value="0" readonly />
          </div>

          <div class="form-group" style="width:100%; max-width:300px; margin-bottom:10px;">
            <label>Total VAT</label>
            <input type="number" id="tax" name="vat" value="0" readonly />
          </div>

          <div class="form-group" style="width:100%; max-width:300px; margin-bottom:10px;">
            <label>Shipping fee</label>
            <input type="number" id="shipping" name="shipping_fee" value="0" onchange="calculateTotal()"/>
          </div>

          <div class="form-group" style="width:100%; max-width:300px; margin-bottom:10px;">
            <label>Total Due</label>
            <input type="number" id="totalDue" name="total_due" value="0" readonly />
          </div>
        </div>
      </div>

      <div class="footer" style="display:flex; justify-content:space-between; align-items:center; margin-top:20px; border-top:1px solid #e0e0e0; padding-top:16px;">
        <a href="{% url 'sales:recurring-invoices' %}" class="text-decoration-none button btn-sm" id="btn">Cancel</a>
        <div class="dropdown">
          <button type="submit" class="btn" style="background:#39B54B; color:#fff; border:none; padding:10px 16px; border-radius:6px;">
            Save Recurring Invoice
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- Scripts -->
  <script>
    (function(){
      const addCustomerUrl = "{% url 'sowaf:add-customer' %}";
      const sel = document.getElementById('customer-select');
      if (sel){
        sel.addEventListener('change', function(){
          if (this.value === 'add_new'){
            window.open(addCustomerUrl, '_blank', 'noopener');
            this.value = '';
          }
        });
      }
    })();

    const PRODUCT_DETAILS_URL_TEMPLATE = "{% url 'sales:product-details' 0 %}";
    function productDetailsUrl(pk){
      return PRODUCT_DETAILS_URL_TEMPLATE.replace("/0/", "/" + pk + "/");
    }

    function handleProductSelect(select){
      if(select.value === "add_new"){
        window.open("{% url 'inventory:add-products' %}", "_blank", "noopener");
        select.value = "";
        return;
      }

      if(!select.value){
        clearProductRow(select);
        calculateTotal();
        return;
      }

      fetch(productDetailsUrl(select.value), { method: "GET" })
        .then(res => res.ok ? res.json() : Promise.reject(res))
        .then(data => {
          if (data.error){
            fillProductDetailsFromDataAttrs(select);
            return;
          }
          fillProductDetailsFromAjax(select, data);
        })
        .catch(() => {
          fillProductDetailsFromDataAttrs(select);
        });
    }

    function clearProductRow(select){
      const row = select.closest("tr");
      row.querySelector(".description").value = "";
      row.querySelector(".rate").value = "";
      row.querySelector(".amount").value = "";
      row.querySelector(".vat").value = "";
      row.querySelector(".discount").value = 0;
      row.querySelector(".discount-amt").value = "";
    }

    function fillProductDetailsFromAjax(select, data){
      const row = select.closest("tr");
      const description = row.querySelector(".description");
      const rate = row.querySelector(".rate");
      const qty = row.querySelector(".qty");
      const amount = row.querySelector(".amount");
      const vat = row.querySelector(".vat");

      description.value = data.sales_description || "";
      if(!rate.value){ rate.value = data.sales_price || 0; }
      qty.value = qty.value || 1;

      const subtotal = (parseFloat(rate.value)||0) * (parseFloat(qty.value)||0);
      amount.value = subtotal.toFixed(2);

      const isTaxable = !!data.taxable;
      vat.value = isTaxable ? ((subtotal * 18) / 100).toFixed(2) : "0.00";

      calculateRow(rate);
    }

    function fillProductDetailsFromDataAttrs(select){
      const row = select.closest("tr");
      const option = select.options[select.selectedIndex];

      const description = row.querySelector(".description");
      const rate = row.querySelector(".rate");
      const qty = row.querySelector(".qty");
      const amount = row.querySelector(".amount");
      const vat = row.querySelector(".vat");

      if(option && option.value){
        description.value = option.getAttribute("data-description") || "";
        if(!rate.value){ rate.value = option.getAttribute("data-rate") || 0; }
        qty.value = qty.value || 1;

        const subtotal = (parseFloat(rate.value)||0) * (parseFloat(qty.value)||0);
        amount.value = subtotal.toFixed(2);

        const isTaxable = option.getAttribute("data-taxable") === "true";
        vat.value = isTaxable ? ((subtotal * 18) / 100).toFixed(2) : "0.00";
      } else {
        description.value = "";
        amount.value = "";
        vat.value = "";
      }
      calculateRow(rate);
    }

    function calculateRow(el){
      const row = el.closest("tr");
      const qty = parseFloat(row.querySelector(".qty").value) || 0;
      const rate = parseFloat(row.querySelector(".rate").value) || 0;
      const amount = row.querySelector(".amount");
      const vat = row.querySelector(".vat");
      const discountPercent = parseFloat(row.querySelector(".discount").value) || 0;
      const discountAmtField = row.querySelector(".discount-amt");

      const subtotal = qty * rate;
      amount.value = subtotal.toFixed(2);

      const option = row.querySelector(".product-select").selectedOptions[0];
      const isTaxable = option && option.getAttribute("data-taxable") === "true";
      vat.value = isTaxable ? ((subtotal * 18) / 100).toFixed(2) : "0.00";

      const discountAmount = (subtotal * discountPercent) / 100;
      discountAmtField.value = discountAmount.toFixed(2);

      calculateTotal();
    }

    function calculateTotal(){
      let subtotal = 0, totalTax = 0, totalDiscount = 0;

      document.querySelectorAll("#invoice-items-table tr").forEach(row => {
        subtotal += parseFloat(row.querySelector(".amount").value) || 0;
        totalTax += parseFloat(row.querySelector(".vat").value) || 0;
        totalDiscount += parseFloat(row.querySelector(".discount-amt").value) || 0;
      });

      const shipping = parseFloat(document.getElementById("shipping").value) || 0;
      const total = subtotal - totalDiscount + totalTax + shipping;

      document.getElementById("subtotal").value = subtotal.toFixed(2);
      document.getElementById("discountAmount").value = totalDiscount.toFixed(2);
      document.getElementById("tax").value = totalTax.toFixed(2);
      document.getElementById("totalDue").value = total.toFixed(2);
    }

    function addRow(){
      const table = document.getElementById("invoice-items-table");
      const base = table.rows[0] ? table.rows[0] : null;
      let newRow;

      if(base){
        newRow = base.cloneNode(true);
        newRow.querySelector(".product-select").selectedIndex = 0;
        newRow.querySelector(".description").value = "";
        newRow.querySelector(".qty").value = 1;
        newRow.querySelector(".rate").value = "";
        newRow.querySelector(".amount").value = "";
        newRow.querySelector(".vat").value = "";
        newRow.querySelector(".discount").value = 0;
        newRow.querySelector(".discount-amt").value = "";
      } else {
        newRow = document.createElement("tr");
        newRow.innerHTML = '<td colspan="9" style="color:#888;">Cannot add row</td>';
      }

      table.appendChild(newRow);
      calculateTotal();
    }

    function deleteRow(btn){
      const table = document.getElementById("invoice-items-table");
      if(table.rows.length > 1){
        btn.closest("tr").remove();
        calculateTotal();
      } else {
        alert("You must keep at least one row!");
      }
    }

    function clearTable(){
      const table = document.getElementById("invoice-items-table");
      while(table.rows.length > 1){
        table.deleteRow(1);
      }

      const firstRow = table.rows[0];
      if(firstRow){
        firstRow.querySelector(".product-select").selectedIndex = 0;
        firstRow.querySelector(".description").value = "";
        firstRow.querySelector(".qty").value = 1;
        firstRow.querySelector(".rate").value = "";
        firstRow.querySelector(".amount").value = "";
        firstRow.querySelector(".vat").value = "";
        firstRow.querySelector(".discount").value = 0;
        firstRow.querySelector(".discount-amt").value = "";
      }
      calculateTotal();
    }

    document.addEventListener('DOMContentLoaded', function(){
      const shippingEl = document.getElementById('shipping');
      if(shippingEl) shippingEl.addEventListener('input', calculateTotal);
      calculateTotal();
    });
  </script>

  {% include 'includes/footer.html' %}
</body>
</html>
