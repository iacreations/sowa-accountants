{% load static %}
{% load humanize %}
{% include 'includes/navbar.html' %}
{% include 'includes/sidebar.html' %}

<style>
  :root{
    --yo-green:#39B54B;
    --yo-dark:#0b3518;
    --yo-bg:#f4f6f8;
    --card:#ffffff;
    --muted:#6b7280;
    --border:#e6e6e6;
    --shadow:0 10px 26px rgba(0,0,0,.08);
    --shadow2:0 14px 34px rgba(0,0,0,.10);
  }

  body{ background:var(--yo-bg); }

  .inv-wrap{
    width:80%;
    margin-left:20%;
    margin-top:7%;
    padding: 0 18px 26px;
  }
  @media (max-width: 1024px){
    .inv-wrap{
      width:95%;
      margin-left:0;
      margin-top:20px;
      padding: 0 12px 22px;
    }
  }

  .inv-hero{
    background:linear-gradient(135deg, rgba(57,181,75,.12) 0%, rgba(255,255,255,1) 45%, rgba(57,181,75,.08) 100%);
    border:1px solid rgba(57,181,75,.18);
    border-radius:16px;
    box-shadow:var(--shadow);
    padding:16px 16px;
  }
  .inv-hero-top{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:14px;
    flex-wrap:wrap;
  }
  .inv-title{
    display:flex;
    flex-direction:column;
    gap:2px;
  }
  .inv-title h1{
    margin:0;
    color:var(--yo-dark);
    font-weight:900;
    letter-spacing:.2px;
  }
  .inv-title p{
    margin:0;
    color:var(--muted);
    font-weight:600;
    font-size:13px;
  }

  .inv-actions{
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
  }
  .yo-btn{
    display:inline-flex;
    align-items:center;
    gap:10px;
    border:none;
    border-radius:12px;
    padding:10px 14px;
    font-weight:900;
    cursor:pointer;
    box-shadow:0 10px 22px rgba(0,0,0,.08);
    transition:transform .12s ease, box-shadow .12s ease, opacity .12s ease;
    text-decoration:none;
    white-space:nowrap;
  }
  .yo-btn:hover{ transform:translateY(-1px); box-shadow:var(--shadow2); }
  .yo-btn:active{ transform:translateY(0); opacity:.95; }
  .yo-btn-primary{ background:var(--yo-green); color:#fff; }
  .yo-btn-soft{ background:#f0fdf4; color:#166534; border:1px solid #cceedd; box-shadow:none; }
  .yo-btn-soft:hover{ box-shadow:0 10px 22px rgba(0,0,0,.08); }

  .inv-tools{
    margin-top:14px;
    display:flex;
    gap:12px;
    align-items:center;
    justify-content:space-between;
    flex-wrap:wrap;
  }

  .search-box{
    flex: 1 1 460px;
    display:flex;
    gap:10px;
    align-items:center;
    background:#fff;
    border:1px solid var(--border);
    border-radius:14px;
    padding:10px 12px;
    box-shadow:0 8px 18px rgba(0,0,0,.06);
  }
  .search-box i{ color:var(--yo-green); font-size:18px; }
  .search-box input{
    border:none;
    outline:none;
    width:100%;
    font-weight:700;
    background:transparent;
  }

  .chips{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:flex-end;
    flex: 1 1 auto;
  }
  .chip{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:8px 12px;
    border-radius:999px;
    border:1px solid var(--border);
    background:#fff;
    font-weight:900;
    color:#111;
    text-decoration:none;
    transition:transform .12s ease, box-shadow .12s ease, background .12s ease;
  }
  .chip:hover{ transform:translateY(-1px); box-shadow:0 10px 18px rgba(0,0,0,.08); }
  .chip.active{
    background:#e8fbef;
    border-color:#c8f0d6;
    color:#0b3518;
  }
  .chip small{
    background:#eef2ff;
    color:#1f2937;
    border-radius:999px;
    padding:2px 8px;
    font-weight:900;
  }
  .chip.overdue small{ background:#ffebee; color:#b71c1c; }
  .chip.paid small{ background:#e8f5e9; color:#2e7d32; }
  .chip.partial small{ background:#fff8e1; color:#a05a00; }

  .inv-card{
    margin-top:14px;
    background:var(--card);
    border-radius:16px;
    box-shadow:var(--shadow);
    border:1px solid #eef0f2;
    overflow:hidden;
  }
  .inv-card-header{
    padding:12px 14px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
    border-bottom:1px solid #eef0f2;
  }
  .inv-card-header .left{
    display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    color:#0b3518; font-weight:900;
  }
  .inv-card-header .left span{
    color:var(--muted); font-weight:800;
  }

  /* Sales-table feel */
  table{ width:100%; border-collapse:separate; border-spacing:0; }

  #invoiceTable thead th{
    background:#185a2e;
    color:#fff;
    font-weight:900;
    font-size:12px;
    text-transform:uppercase;
    letter-spacing:.04em;
    padding:14px 12px;
    white-space:nowrap;
    border-bottom:0;
  }
  #invoiceTable thead th:first-child{ border-top-left-radius:12px; }
  #invoiceTable thead th:last-child{ border-top-right-radius:12px; }

  #invoiceTable tbody td{
    padding:14px 12px;
    border-bottom:1px solid #f1f3f5;
    vertical-align:middle;
    font-weight:700;
    color:#111;
    background:#fff;
  }
  #invoiceTable tbody tr:nth-child(even) td{
    background:#f3f3f3;
  }
  #invoiceTable tbody tr:hover td{
    background:#f6fef8 !important;
  }

  .muted{ color:var(--muted); font-weight:700; }

  .badge{
    display:inline-block; padding:4px 10px; border-radius:999px;
    font-weight:900; font-size:12px; white-space:nowrap;
  }
  .badge-paid     { background:#e8f5e9; color:#2e7d32; }
  .badge-partial  { background:#fff8e1; color:#a05a00; }
  .badge-overdue  { background:#ffebee; color:#b71c1c; }
  .badge-warning  { background:#fff8e1; color:#a05a00; }
  .badge-neutral  { background:#f2f2f2; color:#444; }

  .action-cell { white-space: nowrap; text-align: left; }
  .row-actions { display:inline-flex; align-items:center; gap:8px; position:relative; }

  .edit-link { color:var(--yo-green); font-weight:900; text-decoration:none; }
  .edit-link:hover{ text-decoration:underline; }

  .menu-wrap { position:relative; display:inline-block; }
  .kebab{
    border:1px solid #e6e6e6; background:#fff; color:var(--yo-green);
    width:30px; height:30px; line-height:28px; text-align:center;
    border-radius:10px; cursor:pointer; font-weight:900; padding:0;
  }
  .kebab:focus{ outline:2px solid rgba(57,181,75,.35); outline-offset:2px; }
  .flyout{
    position:absolute; right:0; top: calc(100% + 6px);
    min-width: 210px; background:#fff; border:1px solid #e6e6e6;
    border-radius: 12px; box-shadow:0 12px 28px rgba(0,0,0,.12);
    padding:6px; display:none; z-index:50;
  }
  .menu-wrap.open .flyout{ display:block; }
  .flyout a{
    display:block; padding:9px 10px; border-radius:10px; color:#111;
    text-decoration:none; font-weight:800;
  }
  .flyout a:hover{ background:#f6fef8; }

  tr.click-row { cursor:pointer; }

  /* modal */
  .yo-modal-backdrop{
    position:fixed; inset:0; background:rgba(0,0,0,.35);
    display:none; align-items:center; justify-content:center; z-index:9999;
  }
  .yo-modal-backdrop.show{ display:flex; }
  .yo-modal{
    width:min(520px, 92vw);
    background:#fff; border-radius:16px; box-shadow:0 18px 44px rgba(0,0,0,.2);
    border:1px solid #e6e6e6; overflow:hidden;
  }
  .yo-modal-header{
    padding:12px 14px; display:flex; align-items:center; justify-content:space-between; gap:10px;
    border-bottom:1px solid #eef0f2;
  }
  .yo-modal-header .title{ font-weight:900; color:#0b3518; }
  .yo-modal-body{ padding:12px 14px; }
  .yo-modal-footer{
    padding:12px 14px; display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
    border-top:1px solid #eef0f2;
  }
  .yo-check{
    display:flex; align-items:center; gap:10px;
    padding:10px 12px; border:1px solid #eef0f2; border-radius:12px;
    background:#fff;
  }
  .yo-check input{ width:18px; height:18px; }
</style>

<div class="inv-wrap">

  <div class="inv-hero">
    <div class="inv-hero-top">
      <div class="inv-title">
        <h1>Invoices</h1>
        <p>Search as you type, filter by status, then edit / view / print in one click.</p>
      </div>

      <div class="inv-actions">
        <a class="yo-btn yo-btn-primary" href="{% url 'sales:add-invoice' %}">
          <i class='bx bx-folder-plus'></i> Add New
        </a>

        <form action="{% url 'sowaf:import-customers' %}" method="POST" enctype="multipart/form-data" style="display:flex;">
          {% csrf_token %}
          <input type="file" name="excel_file" accept=".xlsx, .xls, .csv" required style="display:none;" id="excelInput" onchange="this.form.submit()"/>
          <label for="excelInput" class="yo-btn yo-btn-soft" style="margin:0; cursor:pointer;">
            <i class='bx bx-import'></i> Import
          </label>
        </form>
      </div>
    </div>

    <div class="inv-tools">
      <div class="search-box" style="margin:0;">
        <i class='bx bx-search'></i>
        <input
          type="text"
          id="liveSearch"
          placeholder="Search by invoice #, customer name, email, or address..."
          value="{{ q|default:'' }}"
          autocomplete="off"
        />
      </div>

      <div class="chips">
        <a class="chip {% if status_filter == 'all' %}active{% endif %}" href="?status=all">
          All <small>{{ total_all|default:0 }}</small>
        </a>

        <a class="chip overdue {% if status_filter == 'overdue' %}active{% endif %}" href="?status=overdue">
          Overdue <small>{{ counts.overdue|default:0 }}</small>
        </a>

        <a class="chip partial {% if status_filter == 'partial' %}active{% endif %}" href="?status=partial">
          Partially Paid <small>{{ counts.partial|default:0 }}</small>
        </a>

        <a class="chip paid {% if status_filter == 'paid' %}active{% endif %}" href="?status=paid">
          Paid <small>{{ counts.paid|default:0 }}</small>
        </a>
      </div>
    </div>
  </div>

  <div class="inv-card">
    <div class="inv-card-header">
      <div class="left">
        <span>Showing</span> <span id="rowCount">{{ invoices|length }}</span> <span>invoice(s)</span>
      </div>

      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <button type="button" id="openColumns" class="yo-btn yo-btn-soft" style="box-shadow:none;">
          Customize
        </button>

        <a href="{% url 'sowaf:import_customers_template' %}" class="yo-btn yo-btn-soft" style="box-shadow:none;">
          Template
        </a>
      </div>
    </div>

    <div style="overflow-x:auto; overflow-y:visible; padding:14px;">
      <table id="invoiceTable">
        <thead>
          <tr id="headRow">
            {% for key in column_order %}
              {% if key == "invoice_no" %}<th data-col="invoice_no">Invoice no.</th>{% endif %}
              {% if key == "customer" %}<th data-col="customer">Customer Name</th>{% endif %}
              {% if key == "created" %}<th data-col="created">Created date</th>{% endif %}
              {% if key == "due" %}<th data-col="due">Due date</th>{% endif %}
              {% if key == "email" %}<th data-col="email">Email</th>{% endif %}
              {% if key == "billing" %}<th data-col="billing">Billing address</th>{% endif %}
              {% if key == "status" %}<th data-col="status">Status</th>{% endif %}
              {% if key == "actions" %}<th data-col="actions">Actions ▾</th>{% endif %}
            {% endfor %}
          </tr>
        </thead>

        <tbody id="invoiceTableBody">
          {% for inv in invoices %}
            <tr class="click-row" data-edit-url="{% url 'sales:edit-invoice' inv.id %}">
              <td data-col="invoice_no">#{{ inv.id|stringformat:"04d" }}</td>
              <td data-col="customer">{{ inv.customer.customer_name }}</td>
              <td data-col="created" class="muted">{{ inv.date_created|date:"d/m/Y" }}</td>
              <td data-col="due" class="muted">{{ inv.due_date|date:"d/m/Y" }}</td>
              <td data-col="email" class="muted">{{ inv.email|default:"—" }}</td>
              <td data-col="billing" class="muted">{{ inv.billing_address|default:"—" }}</td>

              <td data-col="status">
                {% with s=inv.status %}
                  {% if "Overdue" in s %}
                    <span class="badge badge-overdue">{{ s }}</span>
                  {% elif "Due today" in s %}
                    <span class="badge badge-warning">{{ s }}</span>
                  {% elif "Partially paid" in s %}
                    <span class="badge badge-partial">{{ s }}</span>
                  {% elif "Deposited" in s or "Paid" in s %}
                    <span class="badge badge-paid">{{ s }}</span>
                  {% else %}
                    <span class="badge badge-neutral">{{ s }}</span>
                  {% endif %}
                {% endwith %}
              </td>

              <td data-col="actions" class="action-cell" data-no-row-click="1">
                <div class="row-actions">
                  <a class="edit-link" href="{% url 'sales:edit-invoice' inv.id %}">Edit</a>

                  <div class="menu-wrap">
                    <button class="kebab" aria-haspopup="true" aria-expanded="false" aria-label="More actions">▾</button>
                    <div class="flyout" role="menu">
                      <a role="menuitem" href="{% url 'sales:invoice-detail' inv.id %}">View</a>
                      <a role="menuitem" href="{% url 'sales:invoice-print' inv.id %}">Print / PDF</a>
                      <a role="menuitem" href="{% url 'sales:receive-payment' %}?invoice={{ inv.id }}">Receive payment</a>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="8" style="padding:16px; color:#6b7280; text-align:center;">No invoices available.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>

<!-- Columns Modal -->
<div class="yo-modal-backdrop" id="columnsBackdrop" aria-hidden="true">
  <div class="yo-modal" role="dialog" aria-modal="true" aria-labelledby="colsTitle">
    <div class="yo-modal-header">
      <div class="title" id="colsTitle">Customize Columns</div>
      <button type="button" class="kebab" id="closeColumns" aria-label="Close">✕</button>
    </div>

    <div class="yo-modal-body">
      <div style="margin-bottom:10px; font-weight:800; color:#0b3518;">
        Drag to reorder + tick to show/hide
      </div>

      <div id="colList" style="display:flex; flex-direction:column; gap:10px;">
        {% for key,label in all_columns %}
          <div class="yo-check" draggable="true" data-key="{{ key }}" style="cursor:grab;">
            <input type="checkbox" value="{{ key }}" class="col-check">
            <span style="flex:1;">{{ label }}</span>
            <span style="color:#6b7280;">⋮⋮</span>
          </div>
        {% endfor %}
      </div>

      <div style="margin-top:10px; color:#6b7280; font-weight:700; font-size:12px;">
        Tip: keep “Actions” visible for View / Print.
      </div>
    </div>

    <div class="yo-modal-footer">
      <button type="button" class="yo-btn yo-btn-soft" id="resetCols" style="box-shadow:none;">Reset</button>
      <button type="button" class="yo-btn yo-btn-primary" id="saveCols">Save</button>
    </div>
  </div>
</div>

<script>
  // Row click -> edit page (but ignore actions)
  document.addEventListener("click", function(e){
    const actionArea = e.target.closest("[data-no-row-click='1']");
    const isInsideMenu = e.target.closest(".menu-wrap") || e.target.closest(".flyout") || e.target.closest(".kebab");
    const isLinkOrButton = e.target.closest("a") || e.target.closest("button");
    if (actionArea || isInsideMenu || isLinkOrButton) return;

    const row = e.target.closest("tr.click-row");
    if (row && row.dataset.editUrl){
      window.location.href = row.dataset.editUrl;
    }
  });

  // dropdown menus
  document.addEventListener('click', function(e) {
    const btn = e.target.closest('.kebab');

    document.querySelectorAll('.menu-wrap.open').forEach(w => {
      if (!w.contains(e.target)) {
        w.classList.remove('open');
        const b = w.querySelector('.kebab');
        if (b) b.setAttribute('aria-expanded', 'false');
      }
    });

    if (btn) {
      const wrap = btn.closest('.menu-wrap');
      const open = wrap.classList.toggle('open');
      btn.setAttribute('aria-expanded', String(open));
      e.stopPropagation();
    }
  });

  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      document.querySelectorAll('.menu-wrap.open').forEach(w => {
        w.classList.remove('open');
        const b = w.querySelector('.kebab');
        if (b) b.setAttribute('aria-expanded', 'false');
      });
    }
  });

  // LIVE SEARCH
  (function(){
    const searchInput = document.getElementById("liveSearch");
    const tableBody = document.getElementById("invoiceTableBody");
    const rowCount = document.getElementById("rowCount");
    const statusFilter = "{{ status_filter|default:'all' }}";
    let timer = null;

    function badgeClass(statusText){
      const s = (statusText || "").toLowerCase();
      if (s.includes("overdue")) return "badge-overdue";
      if (s.includes("due today")) return "badge-warning";
      if (s.includes("partially paid")) return "badge-partial";
      if (s.includes("paid") || s.includes("deposited")) return "badge-paid";
      return "badge-neutral";
    }

    function closeAllMenus(){
      document.querySelectorAll('.menu-wrap.open').forEach(w => {
        w.classList.remove('open');
        const b = w.querySelector('.kebab');
        if (b) b.setAttribute('aria-expanded', 'false');
      });
    }

    function renderRows(rows){
      closeAllMenus();
      tableBody.innerHTML = "";

      if (!rows || !rows.length){
        tableBody.innerHTML = `<tr><td colspan="8" style="padding:16px; text-align:center; color:#6b7280;">No results</td></tr>`;
        if(rowCount) rowCount.textContent = "0";
        if (window.__applyOrder) window.__applyOrder(window.__currentOrder || []);
        if (window.__applyColumns) window.__applyColumns(window.__currentVisible || []);
        return;
      }

      rows.forEach(r => {
        const cls = badgeClass(r.status);
        tableBody.insertAdjacentHTML("beforeend", `
          <tr class="click-row" data-edit-url="${r.edit_url}">
            <td data-col="invoice_no">#${r.id}</td>
            <td data-col="customer">${r.customer}</td>
            <td data-col="created" class="muted">${r.created}</td>
            <td data-col="due" class="muted">${r.due}</td>
            <td data-col="email" class="muted">${r.email}</td>
            <td data-col="billing" class="muted">${r.billing}</td>
            <td data-col="status"><span class="badge ${cls}">${r.status}</span></td>
            <td data-col="actions" class="action-cell" data-no-row-click="1">
              <div class="row-actions">
                <a class="edit-link" href="${r.edit_url}">Edit</a>
                <div class="menu-wrap">
                  <button class="kebab" aria-haspopup="true" aria-expanded="false" aria-label="More actions">▾</button>
                  <div class="flyout" role="menu">
                    <a role="menuitem" href="${r.view_url}">View</a>
                    <a role="menuitem" href="${r.print_url}">Print / PDF</a>
                    <a role="menuitem" href="/sales/receive-payment/?invoice=${parseInt(r.id,10)}">Receive payment</a>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        `);
      });

      if(rowCount) rowCount.textContent = String(rows.length);

      if (window.__applyOrder) window.__applyOrder(window.__currentOrder || []);
      if (window.__applyColumns) window.__applyColumns(window.__currentVisible || []);
    }

    function fetchLive(){
      const q = (searchInput.value || "").trim();
      fetch(`?q=${encodeURIComponent(q)}&status=${encodeURIComponent(statusFilter)}`, {
        headers: { "X-Requested-With": "XMLHttpRequest" }
      })
      .then(res => res.json())
      .then(data => renderRows(data.rows || []))
      .catch(() => {});
    }

    if(searchInput){
      searchInput.addEventListener("input", function(){
        clearTimeout(timer);
        timer = setTimeout(fetchLive, 250);
      });
    }
  })();

  // =========================
  // Column Customization
  // =========================
  const initialVisible = {{ visible_columns_json|safe }};
  const initialOrder = {{ column_order_json|safe }};

  let currentVisibleColumns = Array.isArray(initialVisible) && initialVisible.length
    ? initialVisible : ["invoice_no","customer","created","due","email","billing","status","actions"];

  let currentOrder = Array.isArray(initialOrder) && initialOrder.length
    ? initialOrder : ["invoice_no","customer","created","due","email","billing","status","actions"];

  window.__currentVisible = currentVisibleColumns;
  window.__currentOrder = currentOrder;

  const backdrop = document.getElementById("columnsBackdrop");
  const openBtn = document.getElementById("openColumns");
  const closeBtn = document.getElementById("closeColumns");
  const saveBtn = document.getElementById("saveCols");
  const resetBtn = document.getElementById("resetCols");
  const colList = document.getElementById("colList");

  function openColumnsModal(){
    document.querySelectorAll(".col-check").forEach(ch => {
      ch.checked = currentVisibleColumns.includes(ch.value);
    });

    if (colList){
      const map = {};
      colList.querySelectorAll("[data-key]").forEach(item => map[item.dataset.key] = item);
      colList.innerHTML = "";
      currentOrder.forEach(k => { if(map[k]) colList.appendChild(map[k]); });
      Object.keys(map).forEach(k => { if(!currentOrder.includes(k)) colList.appendChild(map[k]); });
    }

    backdrop.classList.add("show");
    backdrop.setAttribute("aria-hidden", "false");
  }

  function closeColumnsModal(){
    backdrop.classList.remove("show");
    backdrop.setAttribute("aria-hidden", "true");
  }

  function getSelectedColumns(){
    const cols = [];
    document.querySelectorAll(".col-check").forEach(ch => {
      if (ch.checked) cols.push(ch.value);
    });
    return cols;
  }

  function getCurrentOrderFromList(){
    const order = [];
    colList.querySelectorAll("[data-key]").forEach(item => order.push(item.dataset.key));
    return order;
  }

  function applyColumns(cols){
    const set = new Set(cols || []);
    document.querySelectorAll("[data-col]").forEach(el => {
      const col = el.getAttribute("data-col");
      el.style.display = set.has(col) ? "" : "none";
    });
  }

  function applyOrder(order){
    const table = document.getElementById("invoiceTable");
    if (!table) return;

    const theadRow = table.querySelector("thead tr");
    const tbody = table.querySelector("tbody");
    if (!theadRow || !tbody) return;

    const thMap = {};
    theadRow.querySelectorAll("th[data-col]").forEach(th => thMap[th.dataset.col] = th);

    if (!order || !order.length) return;

    theadRow.innerHTML = "";
    order.forEach(col => { if (thMap[col]) theadRow.appendChild(thMap[col]); });

    tbody.querySelectorAll("tr").forEach(tr => {
      const tdMap = {};
      tr.querySelectorAll("td[data-col]").forEach(td => tdMap[td.dataset.col] = td);
      if (!Object.keys(tdMap).length) return;

      const saved = {};
      Object.keys(tdMap).forEach(k => saved[k] = tdMap[k]);

      tr.innerHTML = "";
      order.forEach(col => { if (saved[col]) tr.appendChild(saved[col]); });
    });
  }

  window.__applyColumns = applyColumns;
  window.__applyOrder = applyOrder;

  async function saveColumns(){
    const cols = getSelectedColumns();
    const order = getCurrentOrderFromList();

    if (!cols.length){
      alert("Please keep at least one column.");
      return;
    }

    if (!cols.includes("actions")){
      cols.push("actions");
      document.querySelectorAll(".col-check").forEach(ch => {
        if (ch.value === "actions") ch.checked = true;
      });
    }

    const formData = new FormData();
    cols.forEach(c => formData.append("columns[]", c));
    order.forEach(o => formData.append("order[]", o));
    formData.append("csrfmiddlewaretoken", "{{ csrf_token }}");

    const res = await fetch("{% url 'sales:invoice-columns-save' %}", {
      method: "POST",
      body: formData,
      headers: { "X-Requested-With": "XMLHttpRequest" }
    });

    if (res.ok){
      currentVisibleColumns = cols;
      currentOrder = order;

      window.__currentVisible = currentVisibleColumns;
      window.__currentOrder = currentOrder;

      applyOrder(currentOrder);
      applyColumns(currentVisibleColumns);

      closeColumnsModal();
    }
  }

  let dragged = null;

  if (colList){
    colList.addEventListener("dragstart", (e) => {
      const item = e.target.closest("[data-key]");
      if (!item) return;
      dragged = item;
      item.style.opacity = "0.6";
    });

    colList.addEventListener("dragend", (e) => {
      const item = e.target.closest("[data-key]");
      if (!item) return;
      item.style.opacity = "1";
      dragged = null;
    });

    colList.addEventListener("dragover", (e) => {
      e.preventDefault();
      const over = e.target.closest("[data-key]");
      if (!over || !dragged || over === dragged) return;

      const rect = over.getBoundingClientRect();
      const after = (e.clientY - rect.top) > (rect.height / 2);
      colList.insertBefore(dragged, after ? over.nextSibling : over);
    });
  }

  if (openBtn) openBtn.addEventListener("click", openColumnsModal);
  if (closeBtn) closeBtn.addEventListener("click", closeColumnsModal);
  if (backdrop) backdrop.addEventListener("click", (e) => { if (e.target === backdrop) closeColumnsModal(); });
  if (saveBtn) saveBtn.addEventListener("click", saveColumns);

  if (resetBtn) resetBtn.addEventListener("click", () => {
    currentVisibleColumns = ["invoice_no","customer","created","due","email","billing","status","actions"];
    currentOrder = ["invoice_no","customer","created","due","email","billing","status","actions"];

    window.__currentVisible = currentVisibleColumns;
    window.__currentOrder = currentOrder;

    document.querySelectorAll(".col-check").forEach(ch => {
      ch.checked = currentVisibleColumns.includes(ch.value);
    });

    if (colList){
      const map = {};
      colList.querySelectorAll("[data-key]").forEach(item => map[item.dataset.key] = item);
      colList.innerHTML = "";
      currentOrder.forEach(k => { if (map[k]) colList.appendChild(map[k]); });
    }

    applyOrder(currentOrder);
    applyColumns(currentVisibleColumns);
  });

  applyOrder(currentOrder);
  applyColumns(currentVisibleColumns);
</script>

{% include 'includes/footer.html' %}
