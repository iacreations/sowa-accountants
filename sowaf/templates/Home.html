{% load static %}
{% include 'includes/navbar.html' %}
  <style>
    body { background:#f5fbf8; }

/* Container that holds the little tiles */
.dashboard-grid{
  display:grid;
  grid-template-columns: repeat(12, 1fr);
  gap:14px;
}

/* Card */
.kpi-card{
  grid-column: span 6;                /* 2 per row on desktop */
  background:#fff;
  border:1px solid #e9edf3;
  border-radius:14px;
  box-shadow:0 6px 18px rgba(0,0,0,.06);
  padding:14px 16px;
  min-height:170px;
  color: #39B54B;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
}

/* Make some cards wider (e.g. Sales line) */
.kpi-card.wide{ grid-column: span 12; }

/* Header (title + sub) */
.kpi-head{
  display:flex; align-items:baseline; justify-content:space-between;
  gap:10px; margin-bottom:8px;
}
.kpi-title{
  font-weight:700; letter-spacing:.2px;
  color: #39B54B;
}
.kpi-sub{
  font-size:12px; color:#6b7a90;
}

/* Tiny green pill accent */
.kpi-pill{
  background:#e8fbef; color:#1a9d46; 
  border:1px solid #c7f1d6; 
  padding:2px 8px; border-radius:999px; 
  font-size:11px; font-weight:700;
}

/* Canvas area: keeps charts tight */
.kpi-body{ position:relative; height:130px; }
.kpi-body canvas{ width:100% !important; height:100% !important; }

/* Mobile */
@media (max-width: 900px){
  .kpi-card, .kpi-card.wide{ grid-column: span 12; }
}
    @media only screen and (max-width: 600px) {
  #action{
    height: 50px;
    width: 20px;
    background-color: green;
    margin-left: 10%;
    display: flex;
    flex-wrap: 1px;
    justify-content: space-between;
    margin-top: 5%;
  }
   #search{
    display: flex;
    width: 40%;
    margin-top: 0px;
  }
  h1{
    color: white;
  }
  .tabs{
    margin-top: 10%;
  }
  .button{
    width: 30%;
    height: 5vh;
  }

  #main_body {
width: 100%;
margin: 0;
padding-top: 35%;
height: 100vh;

}
  #items{
display: block;
margin: -3%;
padding: 3%;
}
#things{
   margin: 3%;
   width: 100%;
   
}
#Overview{
display: block;
margin-right: 5%;
padding: 3%;
}
.overviews{
   margin: 3%;
   width: 100%;
}
}
/* Laptops & small desktops */
@media only screen and (min-width: 1024px) and (max-width: 1600px) {
/* html, body { overflow: hidden; }  */
#main_body{
  margin-top: 13%;
box-sizing: border-box; 
}
.overviews{
  width:100%;
  background:#fff;
  border:1px solid #e7e7e7;
  border-radius:14px;
  padding:14px;                 /* <— was missing */
  box-shadow:0 8px 22px rgba(0,0,0,.05);
  margin-bottom:14px;
}
}

/* --- Get things done: QB-style tiles (keep our green) --- */
.shortcuts-grid{
  display:grid;
  grid-template-columns:repeat(4,minmax(180px,1fr));
  gap:18px;
}

.shortcut-card{
  background:#0d943e;                 /* our green */
  color:#fff;
  border-radius:16px;
  padding:22px 18px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  text-align:center;
  text-decoration:none;
  box-shadow:0 10px 24px rgba(20,184,78,.18);
  transition:transform .18s ease, box-shadow .18s ease;
  min-height:140px;
  position:relative;
}

.shortcut-card:hover{
  transform:translateY(-3px);
  box-shadow:0 14px 28px rgba(20,184,78,.26);
}

.shortcut-icon{
  width:66px;height:66px;
  border-radius:50%;
  display:grid;place-items:center;
  background:rgba(255,255,255,.14);   /* soft inner circle */
  outline:3px solid rgba(255,255,255,.18);
  margin-bottom:10px;
}

.shortcut-icon i{
  font-size:28px; line-height:1;
  color:#fff;
}

.shortcut-label{
  font-weight:600;
  letter-spacing:.2px;
}

/* small helper for two-line labels on narrow tiles */
.shortcut-label small{
  display:block; opacity:.9; font-weight:500;
}

/* Responsive */
@media (max-width: 1200px){
  .shortcuts-grid{ grid-template-columns:repeat(3,minmax(160px,1fr)); }
}
@media (max-width: 820px){
  .shortcuts-grid{ grid-template-columns:repeat(2,minmax(150px,1fr)); }
}
@media (max-width: 520px){
  .shortcuts-grid{ grid-template-columns:1fr; }
}
#actions{
  display: grid !important;
    grid-template-columns: repeat(2, 1fr) !important;  /* exactly 2 columns */
    gap: 20px !important;
    max-width: 1200px !important;
    margin: 18px auto !important;
    padding: 8px !important;
    box-sizing: border-box !important;

}
#create-actions{
  background: #ffffff !important;
    border-radius: 14px !important;
    padding: 20px !important;
    box-shadow: 0 6px 22px rgba(16, 142, 61, 0.08) !important;
    transition: transform .22s ease, box-shadow .22s ease !important;
    border-left: 6px solid #39B54B !important; /* richer green accent */
    display: flex !important;
    flex-direction: column !important;
    justify-content: flex-start !important;
    min-height: 220px !important; /* equal heights */
    box-sizing: border-box !important;
    overflow: hidden !important;

}
.gtd-card:hover{
    transform: translateY(-6px) !important;
    box-shadow: 0 14px 30px rgba(16,142,61,0.12) !important;
  }
.gtd-head{ display:flex; align-items:center; gap:14px; margin-bottom:10px; }
.gtd-head .icon { font-size: 42px; color: #39B54B; flex: 0 0 auto; }
.gtd-card h3 { margin:0; font-size:20px; font-weight:700; color:#0e0e0e; }
.gtd-card ul { list-style:none; margin: 8px 0 0; padding: 0; display:flex; flex-direction:column; gap:10px; flex: 1 1 auto; }
.gtd-card ul li { margin: 0; padding: 0; }
.gtd-card ul li a { color: #39B54B; text-decoration: none; font-weight:600; font-size:15px; display:inline-block; }
.gtd-card ul li a:hover { text-decoration: underline; }
.gtd-card:focus-within { outline: 3px solid rgba(17,122,43,0.08); }
</style>
{% include 'includes/sidebar.html' %}
    <div class="action" id="action">
      <h1 style="color: #39B54B; font-weight: 600;">HOME</h1>
      <div class="search_bar" id="search"  style="width: 25%;">
        <input type="text" placeholder="Search Home" />
      </div>
        <button class="button">
          <span id="customize" class="button_text">CUSTOMIZE</span>
          <span id="customize" class="button_icon">
            <i class='bx bxs-customize' ></i>
          </span>
        </button>
    </div>
    <div class="main_body" id="main_body">
      <div class="tabs" style="overflow: hidden;">
        <input type="radio" class="tabs_radio" name="tabs-example" id="tab1" checked>
        <label for="tab1" class="tabs_label">Get things done</label>
<div class="tab-content">
   <h4 style="color: #0d943e; text-align: center; font-weight: 800;">Create actions</h4>
<div id="actions">
<div id="create-actions">
 
          <!-- Customers -->
          <div class="gtd-card" tabindex="0" role="group" aria-labelledby="gtd-customers">
            <div class="gtd-head">
              <div class="icon" aria-hidden="true"><i class='bx bx-user-circle'></i></div>
              <h3 id="gtd-customers">Customers</h3>
            </div>
            <ul>
              <li><a href="{% url 'sowaf:add-customer' %}">Add Customer</a></li>
              <li><a href="{% url 'sales:add-receipt' %}">Create sales receipt</a></li>
              <li><a href="{% url 'sales:add-invoice' %}">Create Invoice</a></li>
              <li><a href="{% url 'sales:receive-payment' %}">Record payment</a></li>
              <li><a href="{% url 'sales:statement-new' %}">Create statement</a></li>
              
            </ul>
          </div>
</div>
<div id="create-actions">
<!-- Suppliers -->
          <div class="gtd-card" tabindex="0" role="group" aria-labelledby="gtd-customers">
            <div class="gtd-head">
              <div class="icon" aria-hidden="true"><i class='bx bx-store-alt'></i></div>
              <h3 id="gtd-customers">Suppliers</h3>
            </div>
            <ul>
              <li><a href="{% url 'sowaf:add-supplier' %}">Add Supplier</a></li>
              <li><a href="{% url 'expenses:add-expenses' %}">Record expense</a></li>
              <li><a href="{% url 'expenses:add-cheque' %}">Create cheque</a></li>
              <li><a href="{% url 'expenses:add-bill' %}">Create bill</a></li>
              <li> <a class="tx-item" role="menuitem" href="{% url 'expenses:purchase_order' %}">Create a purchase order</a></li>
            </ul>
          </div>
</div>
<div id="create-actions">
<!-- Employees -->
          <div class="gtd-card" tabindex="0" role="group" aria-labelledby="gtd-customers">
            <div class="gtd-head">
              <div class="icon" aria-hidden="true"><i class='bx bx-group'></i></div>
              <h3 id="gtd-customers">Employees</h3>
            </div>
            <ul>
              <li><a href="{% url 'sowaf:add-employee' %}">Add employee</a></li>
              <!-- <li><a href="{% url 'sowaf:customers' %}">Customer List</a></li>
              <li><a href="{% url 'sales:add-invoice' %}">Create Invoice</a></li>
              <li><a href="{% url 'sales:invoices' %}">Invoice List</a></li> -->
            </ul>
          </div>
</div>
<div id="create-actions">
<!-- Company -->
          <div class="gtd-card" tabindex="0" role="group" aria-labelledby="gtd-customers">
            <div class="gtd-head">
              <div class="icon" aria-hidden="true"><i class='bx bx-user-circle'></i></div>
              <h3 id="gtd-customers">Company</h3>
            </div>
            <ul>
              <li><a href="{% url 'accounts:add-account' %}">Add account</a></li>
              <li><a href="{% url 'accounts:general-ledger' %}">General Ledger</a></li>
              <!-- <li><a href="{% url 'sowaf:customers' %}">Day book</a></li>
              <li><a href="{% url 'sales:add-invoice' %}">Create Invoice</a></li>
              <li><a href="{% url 'sales:invoices' %}">Invoice List</a></li> -->
            </ul>
          </div>
</div>
<div id="create-actions">
<!-- Bank -->
          <div class="gtd-card" tabindex="0" role="group" aria-labelledby="gtd-customers">
            <div class="gtd-head">
              <div class="icon" aria-hidden="true"><i class='bx bx-bank'></i></div>
              <h3 id="gtd-customers">Bank</h3>
            </div>
            <ul>
              <!-- <li><a href="{% url 'sowaf:add-customer' %}">Add Customer</a></li>
              <li><a href="{% url 'sowaf:customers' %}">Customer List</a></li>
              <li><a href="{% url 'sales:add-invoice' %}">Create Invoice</a></li>
              <li><a href="{% url 'sales:invoices' %}">Invoice List</a></li> -->
            </ul>
          </div>
</div>

  </div>
</div>
<input type="radio" class="tabs_radio" name="tabs-example" id="tab2">
<label for="tab2" class="tabs_label">Business Overview</label>
<div class="tab-content">
  <div class="dashboard-grid">

    <!-- Bank balances (donut) -->
    <section class="kpi-card">
      <div class="kpi-head">
        <div class="kpi-title">Bank Account Balance</div>
        
      </div>
      <div class="kpi-sub">{{ range_text }}</div>
      <div class="kpi-body"><canvas id="bankChart"></canvas></div>
    </section>

    <!-- Invoices (stacked bar) -->
    <section class="kpi-card">
      <div class="kpi-head">
        <div class="kpi-title">Invoices</div>
        <div class="kpi-sub">
          {{ inv_counts.paid }} paid • {{ inv_counts.unpaid }} unpaid • {{ inv_counts.over }} overdue
        </div>
      </div>
      <div class="kpi-body"><canvas id="invChart"></canvas></div>
    </section>

    <!-- Outstanding bills (placeholder) -->
    <!-- Bills (line) -->
<section class="kpi-card">
  <div class="kpi-head">
    <div class="kpi-title">Bills (Last 30 days)</div>
    <div class="kpi-sub">{{ range_text }}</div>
  </div>
  <div class="kpi-body"><canvas id="billsChart"></canvas></div>
</section>

<!-- Expenses line - wide -->
<section class="kpi-card wide">
  <div class="kpi-head">
    <div class="kpi-title">Expenses (Last 30 days)</div>
    <div class="kpi-sub">{{ range_text }}</div>
  </div>
  <div class="kpi-body"><canvas id="expLineChart"></canvas></div>
</section>

<!-- Profit/Loss line - wide -->
<section class="kpi-card wide">
  <div class="kpi-head">
    <div class="kpi-title">Profit/Loss (Last 30 days)</div>
    <div class="kpi-sub">{{ range_text }}</div>
  </div>
  <div class="kpi-body"><canvas id="plLineChart"></canvas></div>
</section>
>

    
    <!-- Sales (line) - wide -->
    <section class="kpi-card wide">
      <div class="kpi-head">
        <div class="kpi-title">Sales (Last 30 days)</div>
        <div class="kpi-sub">{{ range_text }}</div>
      </div>
      <div class="kpi-body"><canvas id="salesChart"></canvas></div>
    </section>

  </div>
</div>

<!-- JSON blobs (ids MUST match below) -->
{{ chart_labels|json_script:"labelsJson" }}
{{ sales_series|json_script:"salesJson" }}
{{ exp_labels|json_script:"expLabelsJson" }}
{{ exp_values|json_script:"expValuesJson" }}
{{ bank_labels|json_script:"bankLabelsJson" }}
{{ bank_values|json_script:"bankValuesJson" }}
{{ inv_amounts|json_script:"invAmountsJson" }}
{{ pl_summary|json_script:"plJson" }}
{{ bills_series|json_script:"billsJson" }}
{{ expenses_series|json_script:"expSeriesJson" }}
{{ profit_series|json_script:"profitSeriesJson" }}


<!-- Load Chart.js BEFORE the chart code -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
Chart.defaults.font.family = "'Poppins','Segoe UI',system-ui,-apple-system,Arial";
Chart.defaults.plugins.legend.position = 'bottom';
Chart.defaults.responsive = true;
Chart.defaults.maintainAspectRatio = false;    // lets the card control the height
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  // Safe JSON reader
  const safeParse = (id, fb) => {
    const el = document.getElementById(id);
    if (!el) return fb;
    try { return JSON.parse(el.textContent) ?? fb; } catch { return fb; }
  };

  // Existing blobs
  const L  = safeParse("labelsJson", []);
  const S  = safeParse("salesJson", []).map(n => Number(n)||0);
  const EL = safeParse("expLabelsJson", []);
  const EV = safeParse("expValuesJson", []).map(n => Number(n)||0);
  const BL = safeParse("bankLabelsJson", []);
  const BV = safeParse("bankValuesJson", []).map(n => Number(n)||0);
  const IA = safeParse("invAmountsJson", {paid:0,unpaid:0,overdue:0});
  const PL = safeParse("plJson", {income:0,expense:0,profit:0});

  // NEW daily series
  const BS  = safeParse("billsJson", []).map(n => Number(n)||0);        // bills per day
  const EXS = safeParse("expSeriesJson", []).map(n => Number(n)||0);    // expenses per day
  const PLS = safeParse("profitSeriesJson", []).map(n => Number(n)||0); // net profit per day (+/-)

  // Split profit series into profit vs loss bars
  const profitData = PLS.map(v => v > 0 ? v : 0);
  const lossData   = PLS.map(v => v < 0 ? Math.abs(v) : 0);

  // Chart.js globals
  Chart.defaults.font.family = "'Poppins','Segoe UI',system-ui,-apple-system,Arial";
  Chart.defaults.plugins.legend.position = 'bottom';
  Chart.defaults.responsive = true;
  Chart.defaults.maintainAspectRatio = false;

  const make = (id, cfg) => {
    const c = document.getElementById(id);
    if (!c) return;
    new Chart(c, cfg);
  };

  // Bank donut (unchanged)
  make("bankChart", {
    type: 'doughnut',
    data: { labels: BL, datasets: [{ data: BV }] },
    options: { cutout: '60%' }
  });

  // Sales line (unchanged)
  make("salesChart", {
    type: 'line',
    data: {
      labels: L,
      datasets: [{ label: 'Sales', data: S, tension: .35, fill: false }]
    },
    options: {
      plugins:{ legend:{ display:false }},
      scales:{ y:{ ticks:{ callback:v=>v.toLocaleString() } } }
    }
  });

  // BILLS -> vertical BAR
  make("billsChart", {
    type: 'bar',
    data: {
      labels: L,
      datasets: [{ label: 'Bills', data: BS, borderRadius: 6, maxBarThickness: 18 }]
    },
    options: {
      plugins:{ legend:{ display:false }},
      scales:{ y:{ ticks:{ callback:v=>v.toLocaleString() } } }
    }
  });

  // Expenses donut by account (unchanged)
  make("expChart", {
    type: 'doughnut',
    data: { labels: EL, datasets: [{ data: EV }] },
    options: { cutout: '55%' }
  });

  // Invoices stacked bars (unchanged)
  make("invChart", {
    type: 'bar',
    data: {
      labels: ['Invoices'],
      datasets: [
        { label: 'Paid',    data: [Number(IA.paid)||0] },
        { label: 'Unpaid',  data: [Number(IA.unpaid)||0] },
        { label: 'Overdue', data: [Number(IA.overdue)||0] },
      ]
    },
    options: {
      scales: {
        x: { stacked: true },
        y: { stacked: true, ticks:{ callback:v=>v.toLocaleString() } }
      }
    }
  });

  // P&L snapshot bars (30-day totals, unchanged)
  make("plChart", {
    type: 'bar',
    data: {
      labels: ['Income','Expenses','Net Profit'],
      datasets: [{ data: [Number(PL.income)||0, Number(PL.expense)||0, Number(PL.profit)||0], borderRadius: 6 }]
    },
    options: { plugins:{legend:{display:false}}, scales:{ y:{ ticks:{ callback:v=>v.toLocaleString() } } } }
  });

  // EXPENSES -> AREA (line with fill)
  make("expLineChart", {
    type: 'line',
    data: {
      labels: L,
      datasets: [{ label: 'Expenses', data: EXS, tension: .35, fill: true }]
    },
    options: {
      plugins:{ legend:{ display:false }},
      scales:{ y:{ ticks:{ callback:v=>v.toLocaleString() } } }
    }
  });

  // PROFIT/LOSS -> STACKED BAR (profit vs loss)
  make("plLineChart", {
    type: 'bar',
    data: {
      labels: L,
      datasets: [
        { label: 'Profit', data: profitData, borderRadius: 6, maxBarThickness: 18 },
        { label: 'Loss',   data: lossData,   borderRadius: 6, maxBarThickness: 18 }
      ]
    },
    options: {
      scales: {
        x: { stacked: true },
        y: { stacked: true, ticks:{ callback:v=>v.toLocaleString() } }
      }
    }
  });

});
</script>


 {% include 'includes/footer.html' %}