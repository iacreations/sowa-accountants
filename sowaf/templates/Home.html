{% load static %}
{% load humanize %}
{% include 'includes/navbar.html' %}
<style>
  body { background:#f5fbf8; }

  /* ====== keep your existing styles (unchanged) ====== */

  .dashboard-grid{
    display:grid;
    grid-template-columns: repeat(12, 1fr);
    gap:14px;
  }

  .kpi-card{
    grid-column: span 6;
    background:#fff;
    border:1px solid #e9edf3;
    border-radius:14px;
    box-shadow:0 6px 18px rgba(0,0,0,.06);
    padding:14px 16px;
    min-height:170px;
    color: #39B54B;
    display:flex;
    flex-direction:column;
    justify-content:space-between;
  }
  .kpi-card.wide{ grid-column: span 12; }

  .kpi-head{
    display:flex; align-items:baseline; justify-content:space-between;
    gap:10px; margin-bottom:8px;
  }
  .kpi-title{ font-weight:700; letter-spacing:.2px; color:#39B54B; }
  .kpi-sub{ font-size:12px; color:#6b7a90; }

  .kpi-body{ position:relative; }
  .kpi-body canvas{ width:100% !important; height:100% !important; }

  @media (max-width: 900px){
    .kpi-card, .kpi-card.wide{ grid-column: span 12; }
  }

  /* ====== QB-style Business Overview tiles (NEW, light styles only) ====== */
  .qb-grid{
    display:grid;
    grid-template-columns:repeat(12, 1fr);
    gap:14px;
  }
  .qb-card{
    background:#fff;
    border:1px solid #e9edf3;
    border-radius:14px;
    box-shadow:0 6px 18px rgba(0,0,0,.06);
    padding:14px 16px;
    color:#0f172a;
    min-height:200px;
  }
  .qb-card h4{
    margin:0;
    font-size:13px;
    letter-spacing:.06em;
    color:#111827;
    text-transform:uppercase;
    font-weight:900;
  }
  .qb-top{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-bottom:10px;
  }
  .qb-range{ font-size:12px; color:#6b7280; }

  .qb-money{
    font-size:28px;
    font-weight:900;
    color:#0b1324;
    margin:6px 0 10px;
  }
  .qb-muted{ color:#6b7280; font-size:13px; }
  .qb-link a{ color:#2563eb; text-decoration:none; font-size:13px; }
  .qb-link a:hover{ text-decoration:underline; }

  .bar{
    height:10px; background:#e5e7eb; border-radius:999px; overflow:hidden;
  }
  .bar > span{
    display:block; height:100%;
    background:#39B54B;
    width:40%;
  }

  .bank-row{
    display:flex; justify-content:space-between; gap:10px;
    padding:10px 0;
    border-bottom:1px solid #f1f5f9;
  }
  .bank-row:last-child{ border-bottom:none; }
  .bank-name{ font-weight:800; color:#0b1324; }
  .bank-sub{ font-size:12px; color:#6b7280; }
  .bank-bal{ font-weight:900; color:#0b1324; white-space:nowrap; }

  .mini-2col{
    display:flex; justify-content:space-between; gap:14px;
  }
  .mini-2col .box{ flex:1; }
  .mini-amt{ font-weight:900; color:#0b1324; }

  /* chart heights */
  .donut-wrap{ height:170px; }
  .line-wrap{ height:220px; }

 body { background:#f5fbf8; }

.dashboard-grid{
  display:grid;
  grid-template-columns: repeat(12, 1fr);
  gap:14px;
}

.kpi-card{
  grid-column: span 6;
  background:#fff;
  border:1px solid #e9edf3;
  border-radius:14px;
  box-shadow:0 6px 18px rgba(0,0,0,.06);
  padding:14px 16px;
  min-height:170px;
  color: #39B54B;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
}

.kpi-card.wide{ grid-column: span 12; }

.kpi-head{
  display:flex; align-items:baseline; justify-content:space-between;
  gap:10px; margin-bottom:8px;
}
.kpi-title{
  font-weight:700; letter-spacing:.2px;
  color: #39B54B;
}
.kpi-sub{
  font-size:12px; color:#6b7a90;
}

.kpi-pill{
  background:#e8fbef; color:#1a9d46;
  border:1px solid #c7f1d6;
  padding:2px 8px; border-radius:999px;
  font-size:11px; font-weight:700;
}

.kpi-body{ position:relative; height:130px; }
.kpi-body canvas{ width:100% !important; height:100% !important; }

@media (max-width: 900px){
  .kpi-card, .kpi-card.wide{ grid-column: span 12; }
}
    @media only screen and (max-width: 600px) {
  #action{
    height: 50px;
    width: 20px;
    background-color: green;
    margin-left: 10%;
    display: flex;
    flex-wrap: 1px;
    justify-content: space-between;
    margin-top: 5%;
  }
   #search{
    display: flex;
    width: 40%;
    margin-top: 0px;
  }
  h1{
    color: white;
  }
  .tabs{
    margin-top: 10%;
  }
  .button{
    width: 30%;
    height: 5vh;
  }

  #main_body {
width: 100%;
margin: 0;
padding-top: 35%;
height: 100vh;

}
  #items{
display: block;
margin: -3%;
padding: 3%;
}
#things{
   margin: 3%;
   width: 100%;

}
#Overview{
display: block;
margin-right: 5%;
padding: 3%;
}
.overviews{
   margin: 3%;
   width: 100%;
}
}
@media only screen and (min-width: 1024px) and (max-width: 1600px) {
#main_body{
  margin-top: 13%;
box-sizing: border-box;
}
.overviews{
  width:100%;
  background:#fff;
  border:1px solid #e7e7e7;
  border-radius:14px;
  padding:14px;
  box-shadow:0 8px 22px rgba(0,0,0,.05);
  margin-bottom:14px;
}
}

.shortcuts-grid{
  display:grid;
  grid-template-columns:repeat(4,minmax(180px,1fr));
  gap:18px;
}

.shortcut-card{
  background:#0d943e;
  color:#fff;
  border-radius:16px;
  padding:22px 18px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  text-align:center;
  text-decoration:none;
  box-shadow:0 10px 24px rgba(20,184,78,.18);
  transition:transform .18s ease, box-shadow .18s ease;
  min-height:140px;
  position:relative;
}

.shortcut-card:hover{
  transform:translateY(-3px);
  box-shadow:0 14px 28px rgba(20,184,78,.26);
}

.shortcut-icon{
  width:66px;height:66px;
  border-radius:50%;
  display:grid;place-items:center;
  background:rgba(255,255,255,.14);
  outline:3px solid rgba(255,255,255,.18);
  margin-bottom:10px;
}

.shortcut-icon i{
  font-size:28px; line-height:1;
  color:#fff;
}

.shortcut-label{
  font-weight:600;
  letter-spacing:.2px;
}

.shortcut-label small{
  display:block; opacity:.9; font-weight:500;
}

@media (max-width: 1200px){
  .shortcuts-grid{ grid-template-columns:repeat(3,minmax(160px,1fr)); }
}
@media (max-width: 820px){
  .shortcuts-grid{ grid-template-columns:repeat(2,minmax(150px,1fr)); }
}
@media (max-width: 520px){
  .shortcuts-grid{ grid-template-columns:1fr; }
}
#actions{
  display: grid !important;
    grid-template-columns: repeat(2, 1fr) !important;
    gap: 20px !important;
    max-width: 1200px !important;
    margin: 18px auto !important;
    padding: 8px !important;
    box-sizing: border-box !important;

}
#create-actions{
  background: #ffffff !important;
    border-radius: 14px !important;
    padding: 20px !important;
    box-shadow: 0 6px 22px rgba(16, 142, 61, 0.08) !important;
    transition: transform .22s ease, box-shadow .22s ease !important;
    border-left: 6px solid #39B54B !important;
    display: flex !important;
    flex-direction: column !important;
    justify-content: flex-start !important;
    min-height: 220px !important;
    box-sizing: border-box !important;
    overflow: hidden !important;

}
.gtd-card:hover{
    transform: translateY(-6px) !important;
    box-shadow: 0 14px 30px rgba(16,142,61,0.12) !important;
  }
.gtd-head{ display:flex; align-items:center; gap:14px; margin-bottom:10px; }
.gtd-head .icon { font-size: 42px; color: #39B54B; flex: 0 0 auto; }
.gtd-card h3 { margin:0; font-size:20px; font-weight:700; color:#0e0e0e; }
.gtd-card ul { list-style:none; margin: 8px 0 0; padding: 0; display:flex; flex-direction:column; gap:10px; flex: 1 1 auto; }
.gtd-card ul li { margin: 0; padding: 0; }
.gtd-card ul li a { color: #39B54B; text-decoration: none; font-weight:600; font-size:15px; display:inline-block; }
.gtd-card ul li a:hover { text-decoration: underline; }
.gtd-card:focus-within { outline: 3px solid rgba(17,122,43,0.08); }
</style>

{% include 'includes/sidebar.html' %}

<div class="action" id="action">
  <div style="display:flex; align-items:center; gap:12px;">
    <h1 style="color: #39B54B; font-weight: 600; margin:0;">HOME</h1>

    <!-- âœ… NEW: Welcome message (no style changes, inline only) -->
    {% if request.user.is_authenticated %}
      <span style="
        display:inline-flex;
        align-items:center;
        gap:8px;
        padding:6px 10px;
        border-radius:999px;
        background:#e8fbef;
        border:1px solid #c7f1d6;
        color:#0b3518;
        font-weight:800;
        font-size:12px;
        white-space:nowrap;
      ">
        <i class='bx bx-smile' style="color:#39B54B;"></i>
        Welcome, {{ request.user.username }}
      </span>
    {% endif %}
  </div>

  <div class="search_bar" id="search" style="width: 25%;">
    <input type="text" placeholder="Search Home" />
  </div>
  <button class="button">
    <span id="customize" class="button_text">CUSTOMIZE</span>
    <span id="customize" class="button_icon">
      <i class='bx bxs-customize'></i>
    </span>
  </button>
</div>

<div class="main_body" id="main_body">
  <div class="tabs" style="overflow: hidden;">

    <!-- TAB 1 (unchanged): Get things done -->
    <input type="radio" class="tabs_radio" name="tabs-example" id="tab1"
           {% if request.GET.tab != "tab2" %}checked{% endif %}>
    <label for="tab1" class="tabs_label">Get things done</label>

    <div class="tab-content">
      <h4 style="color: #0d943e; text-align: center; font-weight: 800;">Create actions</h4>
      <div id="actions">

        <div id="create-actions">
          <div class="gtd-card" tabindex="0" role="group" aria-labelledby="gtd-customers">
            <div class="gtd-head">
              <div class="icon" aria-hidden="true"><i class='bx bx-user-circle'></i></div>
              <h3 id="gtd-customers">Customers</h3>
            </div>
            <ul>
              <li><a href="{% url 'sowaf:add-customer' %}">Add Customer</a></li>
              <li><a href="{% url 'sales:add-receipt' %}">Create a Sales Receipt</a></li>
              <li><a href="{% url 'sales:add-invoice' %}">Create an Invoice</a></li>
              <li><a href="{% url 'sales:receive-payment' %}">Make a Sales Collection</a></li>
              <li><a href="{% url 'sales:statement-new' %}">Create a statement</a></li>
            </ul>
          </div>
        </div>

        <div id="create-actions">
          <div class="gtd-card" tabindex="0" role="group" aria-labelledby="gtd-suppliers">
            <div class="gtd-head">
              <div class="icon" aria-hidden="true"><i class='bx bx-store-alt'></i></div>
              <h3 id="gtd-suppliers">Suppliers</h3>
            </div>
            <ul>
              <li><a href="{% url 'expenses:add-bill' %}">Create a Bill</a></li>
              <li><a href="{% url 'expenses:add-expenses' %}">Make an Expense</a></li>
              <li><a href="{% url 'expenses:add-cheque' %}">Create a Cheque</a></li>
              <li><a href="{% url 'expenses:purchase_order' %}">Make Purchase order</a></li>
              <li><a href="{% url 'expenses:supplier-credit' %}">Create a Supplier credit</a></li>
              <li><a href="{% url 'expenses:pay-down-credit' %}">Create a Pay down credit</a></li>
              <li><a href="{% url 'expenses:credit-card' %}">Create a Credit card credit</a></li>
              <li><a href="{% url 'expenses:import-bills' %}">Import bills</a></li>
            </ul>
          </div>
        </div>

        <div id="create-actions">
          <div class="gtd-card" tabindex="0" role="group" aria-labelledby="gtd-employees">
            <div class="gtd-head">
              <div class="icon" aria-hidden="true"><i class='bx bx-group'></i></div>
              <h3 id="gtd-employees">Employees</h3>
            </div>
            <ul>
              <li><a href="{% url 'sowaf:add-employee' %}">Add employee</a></li>
            </ul>
          </div>
        </div>

        <div id="create-actions">
          <div class="gtd-card" tabindex="0" role="group" aria-labelledby="gtd-company">
            <div class="gtd-head">
              <div class="icon" aria-hidden="true"><i class='bx bx-user-circle'></i></div>
              <h3 id="gtd-company">Company</h3>
            </div>
            <ul>
              <li><a href="{% url 'accounts:add-account' %}">Add account</a></li>
              <li><a href="{% url 'accounts:general-ledger' %}">General Ledger</a></li>
            </ul>
          </div>
        </div>

        <div id="create-actions">
          <div class="gtd-card" tabindex="0" role="group" aria-labelledby="gtd-bank">
            <div class="gtd-head">
              <div class="icon" aria-hidden="true"><i class='bx bx-bank'></i></div>
              <h3 id="gtd-bank">Bank</h3>
            </div>
            <ul></ul>
          </div>
        </div>

      </div>
    </div>

    <!-- TAB 2: Business Overview -->
    <input type="radio" class="tabs_radio" name="tabs-example" id="tab2"
           {% if request.GET.tab == "tab2" %}checked{% endif %}>
    <label for="tab2" class="tabs_label">Business Overview</label>

    <div class="tab-content">
      <div id="business-overview"></div>

      <div class="qb-grid">

        <!-- PROFIT & LOSS -->
        <div class="qb-card" style="grid-column: span 4;">
          <div class="qb-top">
            <h4 style="color: #39B54B;">Profit &amp; Loss</h4>

            <div class="qb-range">
              <select
                onchange="setRangeParam('pnl_range', this.value)"
                style="border:1px solid #e5e7eb; border-radius:8px; padding:4px 8px; font-size:12px;">
                {% for k, label in range_options %}
                  <option value="{{ k }}" {% if k == pnl_range_key %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="qb-muted">Net profit for {{ pnl_tile.range_label }}</div>
          <div class="qb-money">{{ pnl_tile.net_profit|floatformat:0|intcomma }}</div>

          <div style="display:grid; gap:10px;">
            <div>
              <div class="qb-muted">Income</div>
              <div class="mini-amt">{{ pnl_tile.income|floatformat:0|intcomma }}</div>
              <div class="bar"><span style="width:70%;"></span></div>
            </div>

            <div>
              <div class="qb-muted">Expenses</div>
              <div class="mini-amt">{{ pnl_tile.expense|floatformat:0|intcomma }}</div>
              <div class="bar"><span style="width:45%; background:#0ea5e9;"></span></div>
            </div>
          </div>

          <div class="qb-link" style="margin-top:10px;">
            <a href="{% url pnl_tile.pnl_url %}{{ pnl_tile.pnl_params }}">See profit and loss report</a>
          </div>
        </div>

        <!-- EXPENSES (donut) -->
        <div class="qb-card" style="grid-column: span 4;">
          <div class="qb-top">
            <h4 style="color: #39B54B;">Expenses</h4>

            <div class="qb-range">
              <select
                onchange="setRangeParam('exp_range', this.value)"
                style="border:1px solid #e5e7eb; border-radius:8px; padding:4px 8px; font-size:12px;">
                {% for k, label in range_options %}
                  <option value="{{ k }}" {% if k == exp_range_key %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="qb-muted">Spending for {{ expenses_tile.range_label|lower }}</div>
          <div class="qb-money">{{ expenses_tile.total|floatformat:0|intcomma }}</div>

          <div class="donut-wrap">
            <canvas id="expDonut"></canvas>
          </div>

          <div class="qb-link" style="margin-top:10px;">
            <a href="{% url expenses_tile.spending_url %}">View all spending</a>
          </div>
        </div>

        <!-- BANK ACCOUNTS (list) -->
        <div class="qb-card" style="grid-column: span 4;">
          <div class="qb-top">
            <h4 style="color: #39B54B;">Bank Accounts</h4>
            <div class="qb-range">As of today</div>
          </div>

          <div style="margin-top:6px;">
            {% for b in bank_rows %}
              <div class="bank-row">
                <div>
                  <div class="bank-name">{{ b.name }}</div>
                  <div class="bank-sub">In YoAccountant</div>
                </div>
                <div class="bank-bal">{{ b.balance|floatformat:0|intcomma }}</div>
              </div>
            {% empty %}
              <div class="qb-muted">No bank/cash accounts found.</div>
            {% endfor %}
          </div>

          <div class="qb-link" style="margin-top:10px;">
            <a href="{% url 'accounts:report-balance-sheet' %}">Go to balance sheet</a>
          </div>
        </div>

        <!-- INVOICES -->
        <div class="qb-card" style="grid-column: span 4;">
          <div class="qb-top">
            <h4 style="color: #39B54B;">Invoices</h4>
            <div class="qb-range">{{ invoices_tile.range_label }}</div>
          </div>

          <div class="qb-muted">Unpaid</div>
          <div class="qb-money">
            {{ invoices_tile.overdue_amount|add:invoices_tile.not_due_amount|floatformat:0|intcomma }}
          </div>

          <div class="mini-2col">
            <div class="box">
              <div class="qb-muted">Overdue</div>
              <div class="mini-amt">{{ invoices_tile.overdue_amount|floatformat:0|intcomma }}</div>
            </div>
            <div class="box">
              <div class="qb-muted">Not due yet</div>
              <div class="mini-amt">{{ invoices_tile.not_due_amount|floatformat:0|intcomma }}</div>
            </div>
          </div>

          <div style="margin-top:10px;" class="bar">
            <span style="width:65%; background:#f59e0b;"></span>
          </div>

          <div class="qb-link" style="margin-top:10px;">
            <a href="{% url invoices_tile.invoices_url %}">See all activity</a>
          </div>
        </div>

        <!-- SALES (line) -->
        <div class="qb-card" style="grid-column: span 8;">
          <div class="qb-top">
            <h4 style="color: #39B54B;">Sales</h4>

            <div class="qb-range">
              <select
                onchange="setRangeParam('sales_range', this.value)"
                style="border:1px solid #e5e7eb; border-radius:8px; padding:4px 8px; font-size:12px;">
                {% for k, label in range_options %}
                  <option value="{{ k }}" {% if k == sales_range_key %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="qb-muted">Total Amount ({{ sales_tile.range_label }})</div>
          <div class="qb-money">{{ sales_tile.total|floatformat:0|intcomma }}</div>

          <div class="line-wrap">
            <canvas id="salesLine"></canvas>
          </div>
        </div>

      </div>
    </div>

  </div>
</div>

{{ exp_labels|json_script:"expLabelsJson" }}
{{ exp_values|json_script:"expValuesJson" }}
{{ sales_tile.labels|json_script:"salesLabelsJson" }}
{{ sales_tile.values|json_script:"salesValuesJson" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function setRangeParam(paramName, val){
  const url = new URL(window.location.href);
  url.searchParams.set(paramName, val);

  url.searchParams.set("tab", "tab2");
  url.hash = "business-overview";

  window.location.href = url.toString();
}

document.addEventListener('DOMContentLoaded', function(){
  const safeParse = (id, fb) => {
    const el = document.getElementById(id);
    if (!el) return fb;
    try { return JSON.parse(el.textContent) ?? fb; } catch { return fb; }
  };

  const u = new URL(window.location.href);
  if (u.searchParams.get("tab") === "tab2") {
    const anchor = document.getElementById("business-overview");
    if (anchor) anchor.scrollIntoView({behavior:"auto", block:"start"});
  }

  const expLabels = safeParse("expLabelsJson", []);
  const expValues = safeParse("expValuesJson", []).map(n => Number(n)||0);
  const salesLabels = safeParse("salesLabelsJson", []);
  const salesValues = safeParse("salesValuesJson", []).map(n => Number(n)||0);

  const expCanvas = document.getElementById("expDonut");
  if (expCanvas){
    new Chart(expCanvas, {
      type: "doughnut",
      data: { labels: expLabels, datasets: [{ data: expValues }] },
      options: { cutout: "60%", plugins:{ legend:{ position:"right" } } }
    });
  }

  const salesCanvas = document.getElementById("salesLine");
  if (salesCanvas){
    new Chart(salesCanvas, {
      type: "line",
      data: { labels: salesLabels, datasets: [{ label:"Amount", data: salesValues, tension:.35, fill:false }] },
      options: {
        plugins:{ legend:{ display:true } },
        scales:{ y:{ ticks:{ callback:(v)=>v.toLocaleString() } } }
      }
    });
  }
});
</script>

{% include 'includes/footer.html' %}
